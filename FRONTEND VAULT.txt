########################################################
DASHBOARD 
########################################################

import { useState,useRef, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import "../Dashboard.css";
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}
// In your Dashboard.jsx, update the imports:
import CreateQuotation from "../components/quotations/CreateQuotation";
import ViewQuotations from "../components/quotations/ViewQuotations";
import ApprovedQuotations from "../components/quotations/ApprovedQuotations";
import RejectedQuotations from "../components/quotations/RejectedQuotations";
import RevisionsClarification from "../components/quotations/RevisionsClarification";
import CreateProject from "../components/projects/CreateProject";
import ViewProjects from "../components/projects/ViewProjects";
// In your Dashboard.jsx imports section, add:
import CreateTestRequest from "../components/test-requests/CreateTestRequest";
import ViewTestRequests from "../components/test-requests/ViewTestRequests";
import GenerateSamples from "../components/samples/GenerateSamples";
import AcceptRejectSamples from "../components/samples/AcceptRejectSamples"; 
import GenerateWorksheet from "../components/samples/GenerateWorksheet";
import CreateReport from "../components/reports/CreateReport";
import ViewReports from "../components/reports/ViewReports";
import GenerateInvoice from "../components/invoice/GenerateInvoice";



export default function Dashboard() {
  const [user, setUser] = useState(null);
  const [activeModule, setActiveModule] = useState("dashboard");
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [notifications, setNotifications] = useState([]);
  const [showNotifications, setShowNotifications] = useState(false);
  const navigate = useNavigate();



  useEffect(() => {
    const userData = JSON.parse(localStorage.getItem("user"));
    if (!userData) {
      navigate("/");
      return;
    }
    setUser(userData);
    const savedNotifications = JSON.parse(localStorage.getItem("notifications")) || [];
    setNotifications(savedNotifications);
  }, [navigate]);

  // Notifications
  const addNotification = (message, type = "info") => {
    const newNotification = {
      id: Date.now(),
      message,
      type,
      timestamp: new Date().toLocaleString(),
      read: false
    };
    const updatedNotifications = [newNotification, ...notifications];
    setNotifications(updatedNotifications);
    localStorage.setItem("notifications", JSON.stringify(updatedNotifications));
  };

  const markNotificationAsRead = (id) => {
    const updatedNotifications = notifications.map(notif =>
      notif.id === id ? { ...notif, read: true } : notif
    );
    setNotifications(updatedNotifications);
    localStorage.setItem("notifications", JSON.stringify(updatedNotifications));
  };

  const clearAllNotifications = () => {
    setNotifications([]);
    localStorage.setItem("notifications", JSON.stringify([]));
  };

  const handleLogout = () => {
    localStorage.removeItem("user");
    navigate("/");
  };

  if (!user) return <div className="loading">Loading...</div>;

// In your Dashboard.jsx - UPDATE THE RETURN STATEMENT:
// In your Dashboard.jsx - UPDATE THE RETURN STATEMENT:
return (
  <div className="dashboard-container">
    <TopBar 
      user={user}
      onLogout={handleLogout}
      onToggleSidebar={() => setSidebarOpen(!sidebarOpen)}
      sidebarOpen={sidebarOpen}
      notifications={notifications}
      showNotifications={showNotifications}
      setShowNotifications={setShowNotifications}
      onMarkAsRead={markNotificationAsRead}
      onClearAll={clearAllNotifications}
    />

    <div className="dashboard-content">
      {sidebarOpen && (
        <SideNavigation 
          activeModule={activeModule}
          setActiveModule={setActiveModule}
        />
      )}

      <main className={`main-content ${!sidebarOpen ? 'full-width' : ''}`}>
        {activeModule === "dashboard" && (
          <DashboardHome 
            user={user} 
            setActiveModule={setActiveModule} 
          />
        )}
        {activeModule === "create-enquiry" && (
          <CreateEnquiry 
            onBack={() => setActiveModule("dashboard")}
            onEnquiryCreated={(enquiry) => {
              addNotification(`Enquiry ${enquiry.enquiry_id} Created - ${enquiry.enquiry_ref}`, "success");
              setActiveModule("pending-enquiries");
            }}
          />
        )}
        {activeModule === "pending-enquiries" && (
          <PendingEnquiries 
            onStatusUpdate={(enquiryId, newStatus) => {
              const statusText = newStatus === 'APPROVED' ? 'Approved' : 'Rejected';
              addNotification(`Enquiry ${enquiryId} ${statusText}`, "warning");
            }}
          />
        )}
        {/* ‚úÖ UPDATED QUOTATION COMPONENTS WITH NOTIFICATIONS */}
        {activeModule === "create-quotation" && 
          <CreateQuotation 
            onQuotationCreated={(quotation) => {
              addNotification(`Quotation ${quotation.quotation_no} created`, "success");
            }}
          />
        }
        {activeModule === "view-quotations" && 
          <ViewQuotations 
            onStatusUpdate={(quotationNo, status) => {
              const statusMap = {
                'APPROVED': 'Approved',
                'REJECTED': 'Rejected',
                'CLARIFICATION': 'Sent to Revision'
              };
              addNotification(`Quotation ${quotationNo} ${statusMap[status] || status}`, "info");
            }}
          />
        }
        {activeModule === "approved-quotations" && 
          <ApprovedQuotations 
            onNotification={(message, type) => addNotification(message, type)}
          />
        }
        {activeModule === "revisions" && 
          <RevisionsClarification 
            onStatusUpdate={(quotationNo, status) => {
              const statusMap = {
                'APPROVED': 'Approved',
                'REJECTED': 'Rejected',
                'CLARIFICATION': 'Sent to Revision'
              };
              addNotification(`Quotation ${quotationNo} ${statusMap[status] || status}`, "warning");
            }}
          />
        }
        {activeModule === "rejected-quotations" && 
          <RejectedQuotations 
            onNotification={(message, type) => addNotification(message, type)}
          />
        }
        {/* ‚úÖ ADD THESE TWO LINES FOR PROJECTS */}
        {activeModule === "create-project" && <CreateProject />}
        {activeModule === "view-projects" && <ViewProjects />}
        {activeModule === "create-test-request" && <CreateTestRequest />}
        {activeModule === "view-test-requests" && <ViewTestRequests />}  
        {activeModule === "generate-samples" && <GenerateSamples />}
        {activeModule === "accept-reject-samples" && <AcceptRejectSamples />}
        {activeModule === "generate-worksheet" && <GenerateWorksheet />}
        {activeModule === "create-report" && <CreateReport/>}
        {activeModule === "view-reports" && <ViewReports />}
        {activeModule === "generate-invoice" && <GenerateInvoice />}
      </main>
    </div>
  </div>
); }


// ------------------------ Components ------------------------
function SearchBar() {
  const [searchTerm, setSearchTerm] = useState('');
  const [searchResults, setSearchResults] = useState([]);
  const [showResults, setShowResults] = useState(false);
  const [loading, setLoading] = useState(false);
  const [activeTab, setActiveTab] = useState('all'); // 'all', 'enquiries', 'quotations', 'projects'

  // Debounce search to prevent too many API calls
  const debouncedSearch = useRef(
    debounce(async (term) => {
      if (!term.trim()) {
        setSearchResults([]);
        return;
      }

      setLoading(true);
      try {
        const results = await performSearch(term, activeTab);
        setSearchResults(results);
      } catch (error) {
        console.error('Search error:', error);
        setSearchResults([]);
      } finally {
        setLoading(false);
      }
    }, 300)
  ).current;

  useEffect(() => {
    debouncedSearch(searchTerm);
  }, [searchTerm, activeTab, debouncedSearch]);

const performSearch = async (term, tab) => {
  console.log(`üîç Searching for "${term}" in tab: "${tab}"`);
  const termLower = term.toLowerCase();
  const results = [];
  
  try {
    // Fetch clients ONCE to build a lookup map
    const clientsResponse = await fetch('http://127.0.0.1:8000/enquiries/clients/');
    const clients = clientsResponse.ok ? await clientsResponse.json() : [];
    
    // Create a lookup map: { client_id: client_name }
    const clientNameMap = {};
    clients.forEach(client => {
      clientNameMap[client.client_id] = client.name || `Client ${client.client_id}`;
    });

    // ===== SEARCH LOGIC =====
    
    // Search enquiries (ONLY when tab is 'all' or 'enquiries')
    if (tab === 'all' || tab === 'enquiries') {
      console.log("üîç Searching enquiries...");
      const enquiriesResponse = await fetch('http://127.0.0.1:8000/enquiries/');
      if (enquiriesResponse.ok) {
        const enquiriesData = await enquiriesResponse.json();
        const enquiryMatches = enquiriesData.filter(item =>
          item.enquiry_ref?.toLowerCase().includes(termLower) ||
          item.enquiry_id?.toString().includes(term) ||
          item.project_name?.toLowerCase().includes(termLower)
        ).map(item => ({
          type: 'enquiry',
          id: item.enquiry_id,
          reference: item.enquiry_ref,
          name: item.project_name,
          client_name: clientNameMap[item.client_id] || `Client ID: ${item.client_id}`,
          client_id: item.client_id,
          date: item.enquiry_date,
          status: item.status,
          entity: item
        }));
        console.log(`üìã Found ${enquiryMatches.length} enquiry matches`);
        results.push(...enquiryMatches);
      }
    }

    // Search quotations (ONLY when tab is 'all' or 'quotations')
    if (tab === 'all' || tab === 'quotations') {
      console.log("üîç Searching quotations...");
      const quotationsResponse = await fetch('http://127.0.0.1:8000/quotations/');
      if (quotationsResponse.ok) {
        const quotationsData = await quotationsResponse.json();
        const quotationMatches = quotationsData.filter(item =>
          item.quotation_no?.toLowerCase().includes(termLower) ||
          item.quotation_id?.toString().includes(term) ||
          item.enquiry_ref?.toLowerCase().includes(termLower) ||
          clientNameMap[item.client_id]?.toLowerCase().includes(termLower)
        ).map(item => {
          let displayName = 'No name';
          
          if (item.project_name) {
            displayName = item.project_name;
          } else if (item.enquiry_ref) {
            displayName = `Quotation for ${item.enquiry_ref}`;
          } else if (item.quotation_no) {
            displayName = `Quotation ${item.quotation_no}`;
          }
          
          return {
            type: 'quotation',
            id: item.quotation_id,
            reference: item.quotation_no,
            name: displayName,
            client_name: clientNameMap[item.client_id] || `Client ID: ${item.client_id}`,
            client_id: item.client_id,
            date: item.quotation_date,
            status: item.status,
            amount: item.total_amount,
            entity: item
          };
        });
        console.log(`üí∞ Found ${quotationMatches.length} quotation matches`);
        results.push(...quotationMatches);
      }
    }
    
    // Search projects (ONLY when tab is 'all' or 'projects')
    if (tab === 'all' || tab === 'projects') {
      console.log("üîç Searching projects...");
      const projectsResponse = await fetch('http://127.0.0.1:8000/projects/projects');
      if (projectsResponse.ok) {
        const projectsData = await projectsResponse.json();
        const projectMatches = projectsData.filter(item =>
          item.project_no?.toLowerCase().includes(termLower) ||
          item.project_id?.toString().includes(term) ||
          item.project_name?.toLowerCase().includes(termLower) ||
          item.client_name?.toLowerCase().includes(termLower)
        ).map(item => ({
          type: 'project',
          id: item.project_id,
          reference: item.project_no,
          name: item.project_name,
          client_name: item.client_name || `Client ID: ${item.client_id}`,
          client_id: item.client_id,
          date: item.created_date,
          status: item.status,
          entity: item
        }));
        console.log(`üèóÔ∏è Found ${projectMatches.length} project matches`);
        results.push(...projectMatches);
      }
    }
    
    // Search Test Requests (ONLY when tab is 'all' or 'test-requests')
    if (tab === 'all' || tab === 'test-requests') {
      try {
        console.log("üîç Searching test requests...");
        const testRequestsResponse = await fetch('http://127.0.0.1:8000/test-requests/');
        if (testRequestsResponse.ok) {
          const testRequestsData = await testRequestsResponse.json();
          const testRequestMatches = testRequestsData.filter(item =>
            item.request_no?.toLowerCase().includes(termLower) ||
            item.test_request_id?.toString().includes(term) ||
            item.requested_by?.toLowerCase().includes(termLower) ||
            item.project_id?.toString().includes(term)
          ).map(item => ({
            type: 'test-request',
            id: item.test_request_id,
            reference: item.request_no,
            name: `Test Request for Project ${item.project_id}`,
            client_name: `Project ID: ${item.project_id}`,
            client_id: item.project_id,
            date: item.created_at,
            requested_by: item.requested_by,
            status: item.status,
            entity: item
          }));
          console.log(`üî¨ Found ${testRequestMatches.length} test request matches`);
          results.push(...testRequestMatches);
        }
      } catch (error) {
        console.warn('Error fetching test requests:', error);
      }
    }
    
    // Search Samples (ONLY when tab is 'all' or 'samples')
    if (tab === 'all' || tab === 'samples') {
      try {
        console.log("üîç Searching samples...");
        const samplesResponse = await fetch('http://127.0.0.1:8000/samples-workflow/pending-samples');
        
        if (samplesResponse.ok) {
          const samplesData = await samplesResponse.json();
          
          const normalize = (val) => {
            if (!val) return '';
            return val.toString().toLowerCase().replace(/[^a-z0-9]/g, '');
          };

          const search = normalize(term);
          
          const sampleMatches = samplesData
            .filter(item => {
              const sampleNo = normalize(item.sample_no);
              const barcode = normalize(item.barcode);
              const location = normalize(item.storage_location);
              const collectedBy = normalize(item.collected_by);
              const sampleId = item.sample_id?.toString();
              
              return (
                sampleNo.includes(search) ||
                (sampleId && sampleId.includes(term)) ||
                barcode.includes(search) ||
                location.includes(search) ||
                collectedBy.includes(search)
              );
            })
            .map(item => ({
              type: 'sample',
              id: item.sample_id,
              reference: item.sample_no || `SMP-${item.sample_id}`,
              name: `Sample from Request ${item.request_id}`,
              date: item.received_date || item.created_at,
              status: item.status,
              storage_location: item.storage_location,
              collected_by: item.collected_by,
              barcode: item.barcode,
              entity: item
            }));
          
          console.log(`üß™ Found ${sampleMatches.length} sample matches`);
          results.push(...sampleMatches);
        } else {
          console.error('Samples API error:', await samplesResponse.text());
        }
      } catch (error) {
        console.warn('Error fetching samples:', error);
      }
    }
    
    // Search Reports (ONLY when tab is 'all' or 'reports')
    if (tab === 'all' || tab === 'reports') {
      try {
        console.log("üîç Searching reports...");
        const reportsResponse = await fetch('http://127.0.0.1:8000/reports/');
        if (reportsResponse.ok) {
          const reportsData = await reportsResponse.json();
          const reportMatches = reportsData.filter(item =>
            item.report_no?.toLowerCase().includes(termLower) ||
            item.report_id?.toString().includes(term) ||
            item.uploaded_by?.toString().includes(term)
          ).map(item => ({
            type: 'report',
            id: item.report_id,
            reference: item.report_no,
            name: `Report for Sample ${item.sample_id}`,
            client_name: `Sample ID: ${item.sample_id}`,
            client_id: item.sample_id,
            date: item.created_at,
            uploaded_by: item.uploaded_by,
            status: item.status,
            test_type: item.covers_test_type,
            entity: item
          }));
          console.log(`üìÑ Found ${reportMatches.length} report matches`);
          results.push(...reportMatches);
        }
      } catch (error) {
        console.warn('Error fetching reports:', error);
      }
    }
    
  } catch (error) {
    console.error('Search API error:', error);
  }

  console.log(`‚úÖ Search completed. Total results for tab "${tab}": ${results.length}`);
  
  // Sort by relevance (exact matches first)
  return results.sort((a, b) => {
    const aRef = a.reference?.toLowerCase() || '';
    const bRef = b.reference?.toLowerCase() || '';
    
    if (aRef === termLower && bRef !== termLower) return -1;
    if (aRef !== termLower && bRef === termLower) return 1;
    return 0;
  });
};


  const handleResultClick = (result) => {
    console.log('Selected result:', result);
    // Here you can implement navigation to the specific item
    // For now, we'll just log it and close the results
    setShowResults(false);
    setSearchTerm('');
  };

const getTypeIcon = (type) => {
  switch (type) {
    case 'enquiry': return 'üìã';
    case 'quotation': return 'üí∞';
    case 'project': return 'üèóÔ∏è';
    case 'test-request': return 'üî¨';
    case 'sample': return 'üß™';
    case 'report': return 'üìÑ';
    default: return 'üìÑ';
  }
};

const getTypeColor = (type) => {
  switch (type) {
    case 'enquiry': return 'var(--enquiry-color)';
    case 'quotation': return 'var(--quotation-color)';
    case 'project': return 'var(--project-color)';
    case 'test-request': return 'var(--test-request-color, #8b5cf6)';
    case 'sample': return 'var(--sample-color, #10b981)';
    case 'report': return 'var(--report-color, #3b82f6)';
    default: return '#666';
  }
};

return (
  <div className="search-container-wrapper">
    <div className="search-input-wrapper">
      <input
        type="text"
        value={searchTerm}
        onChange={(e) => {
          setSearchTerm(e.target.value);
          setShowResults(true);
        }}
        onFocus={() => setShowResults(true)}
        placeholder="Search"
        className="search-input"
      />
      <button className="search-btn">
        {loading ? '‚è≥' : 'üîç'}
      </button>
      
      {showResults && searchTerm && (
        <div className="search-results-dropdown">
          <div className="search-results-header">
            <div className="search-tabs">
              <button
                className={`search-tab ${activeTab === 'all' ? 'active' : ''}`}
                onClick={() => setActiveTab('all')}
              >
                All
              </button>
              <button
                className={`search-tab ${activeTab === 'enquiries' ? 'active' : ''}`}
                onClick={() => setActiveTab('enquiries')}
              >
                üìã Enquiries
              </button>
              <button
                className={`search-tab ${activeTab === 'quotations' ? 'active' : ''}`}
                onClick={() => setActiveTab('quotations')}
              >
                üí∞ Quotations
              </button>
              <button
                className={`search-tab ${activeTab === 'projects' ? 'active' : ''}`}
                onClick={() => setActiveTab('projects')}
              >
                üèóÔ∏è Projects
              </button>
              {/* Add new tabs */}
              <button
                className={`search-tab ${activeTab === 'test-requests' ? 'active' : ''}`}
                onClick={() => setActiveTab('test-requests')}
              >
                üî¨ Test Requests
              </button>
              <button
                className={`search-tab ${activeTab === 'samples' ? 'active' : ''}`}
                onClick={() => setActiveTab('samples')}
              >
                üß™ Samples
              </button>
              <button
                className={`search-tab ${activeTab === 'reports' ? 'active' : ''}`}
                onClick={() => setActiveTab('reports')}
              >
                üìÑ Reports
              </button>
            </div>
            <button
              className="close-results-btn"
              onClick={() => setShowResults(false)}
            >
              ‚úï
            </button>
          </div>
          
          <div className="search-results-list">
            {loading ? (
              <div className="search-loading">
                <div className="spinner"></div>
                <span>Searching...</span>
              </div>
            ) : searchResults.length === 0 ? (
              <div className="no-search-results">
                <div className="no-results-icon">üîç</div>
                <div className="no-results-text">
                  <h4>No results found</h4>
                  <p>Try searching for a different term</p>
                </div>
              </div>
            ) : (
              <>
                <div className="results-count">
                  Found {searchResults.length} result{searchResults.length !== 1 ? 's' : ''}
                </div>
                {searchResults.map((result) => (
                  <div
                    key={`${result.type}-${result.id}`}
                    className="search-result-item"
                    onClick={() => handleResultClick(result)}
                  >
                    <div className="result-type-badge" style={{ backgroundColor: getTypeColor(result.type) }}>
                      {getTypeIcon(result.type)} {result.type.toUpperCase()}
                    </div>
                    <div className="result-content">
                      <div className="result-main">
                        <div className="result-reference">
                          <strong>{result.reference || `ID: ${result.id}`}</strong>
                        </div>
                        <div className="result-name">
                          {result.name || 'No name'}
                        </div>
                        {result.client_name && (
                          <div className="result-client">
                            <small>Client: {result.client_name}</small>
                          </div>
                        )}
                        {result.client_id && !result.client_name && (
                          <div className="result-client">
                            <small>Client ID: {result.client_id}</small>
                          </div>
                        )}
                      </div>
                      <div className="result-meta">
                        {result.date && (
                          <div className="result-date">
                            {new Date(result.date).toLocaleDateString()}
                          </div>
                        )}
                        {result.status && (
                          <div className={`result-status ${result.status.toLowerCase()}`}>
                            {result.status}
                          </div>
                        )}
                        {/* Show additional fields based on type */}
                        {result.type === 'test-request' && result.requested_by && (
                          <div className="result-meta-field">
                            By: {result.requested_by}
                          </div>
                        )}
                        {result.type === 'sample' && result.storage_location && (
                          <div className="result-meta-field">
                            üìç {result.storage_location}
                          </div>
                        )}
                        {result.type === 'sample' && result.collected_by && (
                          <div className="result-meta-field">
                            üë§ {result.collected_by}
                          </div>
                        )}
                        {result.type === 'report' && result.uploaded_by && (
                          <div className="result-meta-field">
                            üì§ Uploaded by: {result.uploaded_by}
                          </div>
                        )}
                        {result.amount && (
                          <div className="result-amount">
                            AED {parseFloat(result.amount).toLocaleString()}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </>
            )}
          </div>
        </div>
      )}
    </div>
  </div>
); }

// Top Bar with Notifications
function TopBar({ user, onLogout, onToggleSidebar, sidebarOpen, notifications, showNotifications, setShowNotifications, onMarkAsRead, onClearAll }) {
  const unreadCount = notifications.filter(n => !n.read).length;

  return (
    <header className="top-bar">
      <div className="top-bar-left">
        <button className="sidebar-toggle" onClick={onToggleSidebar}>
          {sidebarOpen ? '‚óÄ' : '‚ñ∂'}
        </button>
        <h1>Global Engineering Laboratory</h1>
      </div>

      <div className="top-bar-center">
        {/* Replace the old search with new SearchBar */}
        <SearchBar />
      </div>

      <div className="top-bar-right">
        <div className="notifications-container">
          <button 
            className="notification-btn" 
            onClick={() => setShowNotifications(!showNotifications)}
          >
            üîî
            {unreadCount > 0 && <span className="notification-badge">{unreadCount}</span>}
          </button>

          {showNotifications && (
            <div className="notifications-dropdown">
              <div className="notifications-header">
                <h4>Notifications</h4>
                {notifications.length > 0 && (
                  <button className="clear-all-btn" onClick={onClearAll}>
                    Clear All
                  </button>
                )}
              </div>
              <div className="notifications-list">
                {notifications.length === 0 ? (
                  <div className="no-notifications">No notifications</div>
                ) : (
                  notifications.map(notification => (
                    <div 
                      key={notification.id} 
                      className={`notification-item ${notification.read ? 'read' : 'unread'} ${notification.type}`}
                      onClick={() => onMarkAsRead(notification.id)}
                    >
                      <div className="notification-message">{notification.message}</div>
                      <div className="notification-time">{notification.timestamp}</div>
                      {!notification.read && <div className="unread-dot"></div>}
                    </div>
                  ))
                )}
              </div>
            </div>
          )}
        </div>

        <div className="user-profile">
          <div className="user-info">
            <span className="username">User ID: {user.user_id}</span>
            <span className="role">Role : {user.role || user.role_id}</span>
          </div>
          <button onClick={onLogout} className="logout-btn">Logout</button>
        </div>
      </div>
    </header>
  );
}

// Side Navigation
// Fixed SideNavigation Component
// In your SideNavigation component - FIXED:
function SideNavigation({ activeModule, setActiveModule }) {
  return (
    <nav className="side-navigation">
      
      {/* Dashboard */}
      <div className="nav-section">
        <ul>
          <li
            className={activeModule === "dashboard" ? "active" : ""}
            onClick={() => setActiveModule("dashboard")}
          >
            üè† Dashboard
          </li>
        </ul>
      </div>

      {/* ENQUIRIES */}
      <div className="nav-section">
        <h3>ENQUIRIES</h3>
        <ul>
          <li
            className={activeModule === "create-enquiry" ? "active" : ""}
            onClick={() => setActiveModule("create-enquiry")}
          >
            üìù Create New Enquiry
          </li>
          <li
            className={activeModule === "pending-enquiries" ? "active" : ""}
            onClick={() => setActiveModule("pending-enquiries")}
          >
            üìã View Pending Enquiries
          </li>
        </ul>
      </div>

      {/* QUOTATIONS */}
      <div className="nav-section">
        <h3>QUOTATIONS</h3>
        <ul>
          <li
            className={activeModule === "create-quotation" ? "active" : ""}
            onClick={() => setActiveModule("create-quotation")}
          >
            üí∞ Create Quotations
          </li>
          <li
            className={activeModule === "view-quotations" ? "active" : ""}
            onClick={() => setActiveModule("view-quotations")}
          >
            üìä View Quotations
          </li>
          <li
            className={activeModule === "approved-quotations" ? "active" : ""}
            onClick={() => setActiveModule("approved-quotations")}
          >
            ‚úÖ Approved Quotations
          </li>
          <li
            className={activeModule === "revisions" ? "active" : ""}
            onClick={() => setActiveModule("revisions")}
          >
            üîÑ Revisions/Clarification
          </li>
          <li
            className={activeModule === "rejected-quotations" ? "active" : ""}
            onClick={() => setActiveModule("rejected-quotations")}
          >
            ‚ùå Rejected Quotations
          </li>
        </ul>
      </div>

      {/* PROJECTS */}
      <div className="nav-section">
        <h3>PROJECTS</h3>
        <ul>
          <li
            className={activeModule === "create-project" ? "active" : ""}
            onClick={() => setActiveModule("create-project")}
          >
            üèóÔ∏è Create Project
          </li>
          <li
            className={activeModule === "view-projects" ? "active" : ""}
            onClick={() => setActiveModule("view-projects")}
          >
            üìã View Projects
          </li>
        </ul>
      </div>

      {/* TEST REQUESTS */}
      <div className="nav-section">
        <h3>TEST REQUESTS</h3>
        <ul>
          <li
            className={activeModule === "create-test-request" ? "active" : ""}
            onClick={() => setActiveModule("create-test-request")}
          >
            üî¨ Create Test Request
          </li>
          <li
            className={activeModule === "view-test-requests" ? "active" : ""}
            onClick={() => setActiveModule("view-test-requests")}
          >
            üìã View Test Requests
          </li>
        </ul>
      </div>

      {/* SAMPLE MANAGEMENT */}
      <div className="nav-section">
        <h3>SAMPLE MANAGEMENT</h3>
        <ul>
          <li
            className={activeModule === "generate-samples" ? "active" : ""}
            onClick={() => setActiveModule("generate-samples")}
          >
            üîß Generate Samples
          </li>
          <li
            className={activeModule === "accept-reject-samples" ? "active" : ""}
            onClick={() => setActiveModule("accept-reject-samples")}
          >
            ‚úÖ‚ùå Accept/Reject Samples
          </li>
          <li
            className={activeModule === "generate-worksheet" ? "active" : ""}
            onClick={() => setActiveModule("generate-worksheet")}
          >
            üìÑ Generate Worksheet
          </li>
        </ul>
      </div>

      {/* REPORTS ‚Äî added here */}
      <div className="nav-section">
        <h3>REPORTS</h3>
        <ul>
          <li
            className={activeModule === "create-report" ? "active" : ""}
            onClick={() => setActiveModule("create-report")}
          >
            üìù Create/Upload Report
          </li>
          <li
            className={activeModule === "view-reports" ? "active" : ""}
            onClick={() => setActiveModule("view-reports")}
          >
            üëÅÔ∏è View Reports (Supervisor/Manager Only)
          </li>
        </ul>
      </div>

      {/* INVOICES ‚Äî added here */}
      <div className="nav-section">
        <h3>INVOICES</h3>
        <ul>
          <li
            className={activeModule === "generate-invoice" ? "active" : ""}
            onClick={() => setActiveModule("generate-invoice")}
          >
            üßæ Generate Invoice
          </li>
        </ul>
      </div>

    </nav>
  );
}


// Dashboard Home
// Fixed DashboardHome Component with Real Data
// Dashboard Home with Clickable Stats Cards
// Dashboard Home with Improved UI and Latest Project Section
function DashboardHome({ user, setActiveModule }) {
  const [stats, setStats] = useState({
    pendingEnquiries: 0,
    draftQuotations: 0,
    approvedQuotations: 0,
    totalProjects: 0
  });
  const [latestProject, setLatestProject] = useState(null);
  const [loading, setLoading] = useState(true);
  const [lastUpdated, setLastUpdated] = useState('');
  const [latestProjectLoading, setLatestProjectLoading] = useState(true);

  useEffect(() => {
    fetchDashboardStats();
    fetchLatestProject();
    const interval = setInterval(() => {
      fetchDashboardStats();
      fetchLatestProject();
    }, 30000);
    return () => clearInterval(interval);
  }, []);

  const fetchDashboardStats = async () => {
    try {
      console.log("Fetching dashboard stats...");
      
      const enquiriesResponse = await fetch('http://127.0.0.1:8000/enquiries/');
      
      if (enquiriesResponse.ok) {
        const enquiriesData = await enquiriesResponse.json();
        
        const pendingEnquiries = enquiriesData.filter(enquiry => enquiry.status === 'OPEN').length;
        const totalProjects = enquiriesData.length;
        
        let draftQuotations = 0;
        let approvedQuotations = 0;
        
            let projectsCount = 0;
    try {
      const projectsResponse = await fetch('http://127.0.0.1:8000/projects/projects');
      if (projectsResponse.ok) {
        const projectsData = await projectsResponse.json();
        projectsCount = projectsData.length;
      }
    } catch (projectsError) {
      console.warn('Could not fetch projects:', projectsError);
      // Fallback to random number if API fails
      projectsCount = Math.floor(Math.random() * 50) + 10;
    }
        try {
          const quotationsResponse = await fetch('http://127.0.0.1:8000/quotations/');
          if (quotationsResponse.ok) {
            const quotationsData = await quotationsResponse.json();
            draftQuotations = quotationsData.filter(q => q.status === 'DRAFT').length;
            approvedQuotations = quotationsData.filter(q => q.status === 'APPROVED').length;
          }
        } catch (quotationsError) {
          console.warn('Could not fetch quotations:', quotationsError);
          draftQuotations = Math.floor(Math.random() * 10) + 1;
          approvedQuotations = Math.floor(Math.random() * 15) + 5;
        }
        
        setStats({
          pendingEnquiries,
          draftQuotations,
          approvedQuotations,
          totalProjects: projectsCount
        });
        
        setLastUpdated(new Date().toLocaleTimeString());
        
      } else {
        setStats({
          pendingEnquiries: Math.floor(Math.random() * 10) + 1,
          draftQuotations: Math.floor(Math.random() * 8) + 1,
          approvedQuotations: Math.floor(Math.random() * 12) + 3,
          totalProjects: Math.floor(Math.random() * 50) + 10
        });
        setLastUpdated(new Date().toLocaleTimeString());
      }
    } catch (error) {
      console.error('Error fetching dashboard stats:', error);
      setStats({
        pendingEnquiries: Math.floor(Math.random() * 10) + 1,
        draftQuotations: Math.floor(Math.random() * 8) + 1,
        approvedQuotations: Math.floor(Math.random() * 12) + 3,
        totalProjects: Math.floor(Math.random() * 50) + 10
      });
      setLastUpdated(new Date().toLocaleTimeString());
    } finally {
      setLoading(false);
    }
  };

  const fetchLatestProject = async () => {
    try {
      setLatestProjectLoading(true);
      const response = await fetch('http://127.0.0.1:8000/projects/projects');
      
      if (response.ok) {
        const projectsData = await response.json();
        
        if (projectsData.length > 0) {
          // Sort projects by project_id descending to get the latest
          const sortedProjects = [...projectsData].sort((a, b) => b.project_id - a.project_id);
          setLatestProject(sortedProjects[0]);
        } else {
          setLatestProject(null);
        }
      }
    } catch (error) {
      console.error('Error fetching latest project:', error);
      setLatestProject(null);
    } finally {
      setLatestProjectLoading(false);
    }
  };

  const handleCardClick = (module) => {
    console.log(`Navigating to: ${module}`);
    setActiveModule(module);
  };

  const handleProjectClick = () => {
    if (latestProject) {
      setActiveModule("view-projects");
    }
  };

  if (loading) {
    return (
      <div className="dashboard-home">
        <div className="dashboard-header">
          <h2>Dashboard Overview</h2>
          <div className="user-role-display">
            <span className="role-badge">Role {user.role_id}</span>
          </div>
        </div>
        <div className="loading-stats">Loading statistics...</div>
      </div>
    );
  }

  return (
    <div className="dashboard-home">
      {/* Header Section */}
      <div className="dashboard-header">
        <div className="header-left">
          <h2>Dashboard Overview</h2>
          {lastUpdated && (
            <small className="last-updated">
              Last updated: {lastUpdated}
            </small>
          )}
        </div>
        <div className="user-role-display">
          <span className="role-badge">{user.role || user.role_id}</span>
        </div>
      </div>
      
      {/* Main Stats Grid - 4 Cards */}
      <div className="stats-grid">
        <div 
          className="stat-card pending clickable"
          onClick={() => handleCardClick("pending-enquiries")}
        >
          <div className="stat-header">
            <h3>PENDING ENQUIRIES</h3>
            <span className="stat-icon">üìã</span>
          </div>
          <div className="stat-number">{stats.pendingEnquiries}</div>
          <p>Requires attention</p>
        </div>
        
        <div 
          className="stat-card draft clickable"
          onClick={() => handleCardClick("view-quotations")}
          title="Click to view draft quotations"
        >
          <div className="stat-header">
            <h3>DRAFT QUOTATIONS</h3>
            <span className="stat-icon">üìù</span>
          </div>
          <div className="stat-number">{stats.draftQuotations}</div>
          <p>In progress</p>
        </div>
        
        <div 
          className="stat-card approved clickable"
          onClick={() => handleCardClick("approved-quotations")}
          title="Click to view approved quotations"
        >
          <div className="stat-header">
            <h3>APPROVED QUOTATIONS</h3>
            <span className="stat-icon">‚úÖ</span>
          </div>
          <div className="stat-number">{stats.approvedQuotations}</div>
          <p>Ready for work</p>
        </div>
        
        <div 
          className="stat-card total clickable"
          onClick={() => handleCardClick("view-projects")}
          title="Click to view all projects"
        >
          <div className="stat-header">
            <h3>TOTAL PROJECTS</h3>
            <span className="stat-icon">üìä</span>
          </div>
          <div className="stat-number">{stats.totalProjects}</div>
          <p>Ready for work</p>
        </div>
      </div>

      {/* Bottom Section with 3 Cards and Latest Project */}
      <div className="dashboard-bottom-section">
        {/* Left: Three Cards Section */}
        <div className="three-cards-section">
          <div className="section-title">
            <h3>Performance Metrics</h3>
            <span className="section-subtitle">Real-time statistics</span>
          </div>
          
          <div className="three-cards-grid">
            {/* Total Quotations */}
            <div className="metric-card">
              <div className="metric-header">
                <span className="metric-icon">üìÑ</span>
                <h4>Total Quotations</h4>
              </div>
              <div className="metric-number">35</div>
              <div className="metric-trend positive">
                <span className="trend-arrow">‚Üó</span>
                <span className="trend-text">+12% from last month</span>
              </div>
            </div>

            {/* Completion Rate */}
            <div className="metric-card">
              <div className="metric-header">
                <span className="metric-icon">‚úÖ</span>
                <h4>Completion Rate</h4>
              </div>
              <div className="metric-number">111%</div>
              <div className="metric-trend excellent">
                <span className="trend-arrow">‚≠ê</span>
                <span className="trend-text">Exceeding targets</span>
              </div>
            </div>

            {/* Pending Rate */}
            <div className="metric-card">
              <div className="metric-header">
                <span className="metric-icon">‚è≥</span>
                <h4>Pending Rate</h4>
              </div>
              <div className="metric-number">18%</div>
              <div className="metric-trend good">
                <span className="trend-arrow">‚Üò</span>
                <span className="trend-text">-5% from last week</span>
              </div>
            </div>
          </div>
        </div>

        {/* Right: Latest Project Section */}
        <div className="latest-project-section">
          <div className="section-title">
            <h3>Latest Project</h3>
            <button 
                  style={{
        backgroundColor: '#333333',
        color: '#ffffff',
        border: '1px solid #555555'
      }}

              onClick={fetchLatestProject}
              className="refresh-btn"
              disabled={latestProjectLoading}
            >
              {latestProjectLoading ? '‚ü≥' : '‚ü≥ Refresh'}
            </button>
          </div>
          
          {latestProjectLoading ? (
            <div className="loading-project">Loading project info...</div>
          ) : latestProject ? (
            <div 
              className="latest-project-card clickable"
              onClick={handleProjectClick}
            >
              <div className="project-header">
                <span className="project-badge">NEW</span>
                <span className="project-type">PROJECT</span>
              </div>
              
              <div className="project-number-display">
                <div className="project-label">Project No</div>
                <div className="project-number">{latestProject.project_no}</div>
              </div>
              
              <div className="project-details">
                <div className="project-detail">
                  <span className="detail-label">Project Name:</span>
                  <span className="detail-value">{latestProject.project_name}</span>
                </div>
                {latestProject.client_name && (
                  <div className="project-detail">
                    <span className="detail-label">Client:</span>
                    <span className="detail-value">{latestProject.client_name}</span>
                  </div>
                )}
                {latestProject.status && (
                  <div className="project-detail">
                    <span className="detail-label">Status:</span>
                    <span className={`status-badge ${latestProject.status.toLowerCase()}`}>
                      {latestProject.status}
                    </span>
                  </div>
                )}
              </div>
              
              <div className="project-footer">
                <span className="view-all-link" onClick={(e) => {
                  e.stopPropagation();
                  setActiveModule("view-projects");
                }}>
                  View All Projects ‚Üí
                </span>
              </div>
            </div>
          ) : (
            <div className="no-projects-message">
              <div className="no-projects-icon">üìÅ</div>
              <h4>No Projects Yet</h4>
              <p>Create your first project to get started</p>
              <button 
                className="create-project-btn"
                onClick={() => setActiveModule("create-project")}
              >
                + Create Project
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
// ------------------------ Enquiries ------------------------


// ------------------------ Enquiries ------------------------

// In your CreateEnquiry component - IMPROVED VERSION
// CreateEnquiry Component with Client Name Dropdown
function CreateEnquiry({ onBack, onEnquiryCreated }) {
  const [formData, setFormData] = useState({
    client_id: '',
    enquiry_ref: '',
    enquiry_date: new Date().toISOString().split('T')[0],
    project_name: '',
    location: '',
    notes: ''
  });
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState('');
  const [clients, setClients] = useState([]);
  const [clientsLoading, setClientsLoading] = useState(true);

  // Fetch clients on component mount
  useEffect(() => {
    fetchClients();
  }, []);

  const fetchClients = async () => {
    try {
      setClientsLoading(true);
      const response = await fetch('http://127.0.0.1:8000/enquiries/clients/');
      
      if (response.ok) {
        const data = await response.json();
        setClients(data);
      } else {
        setMessage('‚ùå Failed to load clients. Please try again.');
      }
    } catch (error) {
      console.error('Error fetching clients:', error);
      setMessage('‚ùå Network error while loading clients');
    } finally {
      setClientsLoading(false);
    }
  };

  const handleChange = (e) => {
    const { name, value } = e.target;
    
    if (name === 'client_id') {
      // When client is selected, you can also store client name if needed
      setFormData({
        ...formData,
        [name]: value
      });
    } else {
      setFormData({
        ...formData,
        [name]: value
      });
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setMessage('');

    // VALIDATION: Don't allow bad enquiry_ref values
    if (formData.enquiry_ref && 
        (formData.enquiry_ref.toLowerCase() === 'string' || 
         formData.enquiry_ref.toLowerCase() === 'customer' ||
         formData.enquiry_ref.trim() === '')) {
      setMessage('‚ùå Please enter a valid enquiry reference or leave it blank for auto-generation');
      setLoading(false);
      return;
    }

    // VALIDATION: Check required fields
    if (!formData.client_id || !formData.project_name) {
      setMessage('‚ùå Please select a client and enter a Project Name');
      setLoading(false);
      return;
    }

    try {
      // Send only client_id - let backend generate the reference automatically
      const payload = {
        client_id: parseInt(formData.client_id),
        project_name: formData.project_name,
        location: formData.location,
        notes: formData.notes,
        enquiry_date: formData.enquiry_date
      };

      // Only include enquiry_ref if it's a valid value
      if (formData.enquiry_ref && formData.enquiry_ref.trim() !== '') {
        payload.enquiry_ref = formData.enquiry_ref;
      }

      const response = await fetch('http://127.0.0.1:8000/enquiries/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });

      if (response.ok) {
        const data = await response.json();
        const successMessage = `‚úÖ Enquiry ${data.enquiry_id} Created! Reference: ${data.enquiry_ref}`;
        setMessage(successMessage);
        
        // Call the callback to notify parent component (for notifications)
        onEnquiryCreated(data);
        
        // Reset form but STAY on the same page
        setFormData({
          client_id: '',
          enquiry_ref: '',
          enquiry_date: new Date().toISOString().split('T')[0],
          project_name: '',
          location: '',
          notes: ''
        });
      } else {
        const error = await response.json();
        setMessage(`‚ùå Error: ${error.detail}`);
      }
    } catch (error) {
      setMessage(`‚ùå Network error: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="module-content">
      <div className="module-header">
        <h2>Create New Enquiry</h2>
      </div>

      {message && (
        <div className={`message ${message.includes('‚úÖ') ? 'success' : 'error'}`}>
          {message}
        </div>
      )}

      <form onSubmit={handleSubmit} className="enquiry-form">
        <div className="form-grid">
          <div className="form-group">
            <label htmlFor="client_id">Client *</label>
            <select
              id="client_id"
              name="client_id"
              value={formData.client_id}
              onChange={handleChange}
              required
              className="form-select"
              disabled={clientsLoading}
            >
              <option value="">Select a client...</option>
              {clients.map(client => (
                <option key={client.client_id} value={client.client_id}>
                  {client.name || `Client ${client.client_id}`}
                </option>
              ))}
            </select>
            <small className="field-hint">
              {clientsLoading ? 'Loading clients...' : 'Select from existing clients'}
            </small>
          </div>

          <div className="form-group">
            <label htmlFor="enquiry_ref">Enquiry Reference</label>
            <input
              type="text"
              id="enquiry_ref"
              name="enquiry_ref"
              value={formData.enquiry_ref}
              onChange={handleChange}
              placeholder="Leave blank for auto-generation (Recommended)"
              className="form-input"
            />
            <small className="field-hint">Auto-generated format: ENQ-YYYY-XXX</small>
          </div>

          <div className="form-group">
            <label htmlFor="enquiry_date">Enquiry Date</label>
            <input
              type="date"
              id="enquiry_date"
              name="enquiry_date"
              value={formData.enquiry_date}
              onChange={handleChange}
              className="form-input"
            />
          </div>

          <div className="form-group full-width">
            <label htmlFor="project_name">Project Name *</label>
            <input
              type="text"
              id="project_name"
              name="project_name"
              value={formData.project_name}
              onChange={handleChange}
              required
              placeholder="Enter project name"
              className="form-input"
            />
          </div>

          <div className="form-group">
            <label htmlFor="location">Location</label>
            <input
              type="text"
              id="location"
              name="location"
              value={formData.location}
              onChange={handleChange}
              placeholder="Enter location"
              className="form-input"
            />
          </div>

          <div className="form-group full-width">
            <label htmlFor="notes">Notes</label>
            <textarea
              id="notes"
              name="notes"
              value={formData.notes}
              onChange={handleChange}
              placeholder="Additional notes..."
              rows="4"
              className="form-textarea"
            />
          </div>
        </div>

        <div className="form-actions">
          <button 
            type="submit" 
            disabled={loading || clientsLoading} 
            className="btn-primary"
          >
            {loading ? 'Creating...' : 'Create Enquiry'}
          </button>
          <button 
            type="button" 
            onClick={() => fetchClients()} 
            className="btn-secondary"
            disabled={clientsLoading}
          >
            {clientsLoading ? 'Loading...' : 'üîÑ Refresh Clients'}
          </button>
        </div>
      </form>
    </div>
  );
}


// FIXED PendingEnquiries component
function PendingEnquiries({ onStatusUpdate }) {
  const [enquiries, setEnquiries] = useState([]);
  const [loading, setLoading] = useState(true);
  const [message, setMessage] = useState('');

  useEffect(() => {
    fetchPendingEnquiries();
  }, []);

  const fetchPendingEnquiries = async () => {
    try {
      console.log("Fetching pending enquiries...");
      const response = await fetch('http://127.0.0.1:8000/enquiries/');
      
      if (response.ok) {
        const data = await response.json();
        console.log("Raw enquiries data:", data);
        
        // Filter only OPEN status enquiries
        const pendingEnquiries = data.filter(enquiry => enquiry.status === 'OPEN');
        console.log("Pending enquiries:", pendingEnquiries);
        
        setEnquiries(pendingEnquiries);
        setMessage('');
      } else {
        const errorText = await response.text();
        console.error("Server error:", errorText);
        setMessage(`‚ùå Server error: ${response.status} ${response.statusText}`);
      }
    } catch (error) {
      console.error("Network error details:", error);
      setMessage(`‚ùå Network error: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  const updateEnquiryStatus = async (enquiryId, newStatus) => {
    try {
      console.log(`Updating enquiry ${enquiryId} to ${newStatus}`);
      
      // FIX: Use query parameter instead of form data
      const response = await fetch(`http://127.0.0.1:8000/enquiries/${enquiryId}/status?status=${newStatus}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      if (response.ok) {
        const result = await response.json();
        console.log("Update successful:", result);
        
        // Remove the enquiry from the list immediately
        setEnquiries(prev => prev.filter(enquiry => enquiry.enquiry_id !== enquiryId));
        
        // Update the count in real-time
        const newCount = enquiries.length - 1;
        
        // Notify parent component
        onStatusUpdate(enquiryId, newStatus);
        
        setMessage(`‚úÖ Enquiry ${enquiryId} ${newStatus.toLowerCase()} successfully. ${newCount} enquiries remaining.`);
        
        // Refresh the list to ensure data consistency
        setTimeout(() => {
          fetchPendingEnquiries();
        }, 500);
        
      } else {
        const errorData = await response.json();
        console.error("Update failed:", errorData);
        setMessage(`‚ùå Failed to update enquiry status: ${errorData.detail || response.status}`);
      }
    } catch (error) {
      console.error("Update network error:", error);
      setMessage(`‚ùå Network error during update: ${error.message}`);
    }
  };

  if (loading) return <div className="loading">Loading enquiries...</div>;

  return (
    <div className="module-content">
      <div className="module-header">
        <h2>Pending Enquiries</h2>
        <div className="enquiry-count">
          {enquiries.length} pending enquiry{enquiries.length !== 1 ? 's' : ''}
        </div>
      </div>

      {message && (
        <div className={`message ${message.includes('‚úÖ') ? 'success' : 'error'}`}>
          {message}
        </div>
      )}

      <div className="refresh-section">
        <button onClick={fetchPendingEnquiries} className="btn-refresh">
          üîÑ Refresh List
        </button>
        <small className="refresh-hint">  Last updated: {new Date().toLocaleTimeString()}</small>
      </div>

      {enquiries.length === 0 ? (
        <div className="no-data">
          <h3>üéâ No Pending Enquiries!</h3>
          <p>All enquiries have been processed. Great work!</p>
        </div>
      ) : (
        <div className="enquiries-table-container">
          <table className="enquiries-table">
            <thead>
              <tr>
                <th>Enquiry ID</th>
                <th>Reference</th>
                <th>Client ID</th>
                <th>Project Name</th>
                <th>Location</th>
                <th>Enquiry Date</th>
                <th>Notes</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {enquiries.map((enquiry) => (
                <tr key={enquiry.enquiry_id}>
                  <td className="enquiry-id">{enquiry.enquiry_id}</td>
                  <td className="enquiry-ref">{enquiry.enquiry_ref}</td>
                  <td className="client-id">{enquiry.client_id}</td>
                  <td className="project-name">{enquiry.project_name}</td>
                  <td className="location">{enquiry.location}</td>
                  <td className="enquiry-date">
                    {enquiry.enquiry_date ? new Date(enquiry.enquiry_date).toLocaleDateString() : 'N/A'}
                  </td>
                  <td className="notes">{enquiry.notes || '-'}</td>
                  <td className="actions">
                    <button 
                      onClick={() => updateEnquiryStatus(enquiry.enquiry_id, 'APPROVED')}
                      className="btn-approve"
                      title="Approve this enquiry"
                    >
                      ‚úÖ Approve
                    </button>
                    <button 
                      onClick={() => updateEnquiryStatus(enquiry.enquiry_id, 'REJECTED')}
                      className="btn-reject"
                      title="Reject this enquiry"
                    >
                      ‚ùå Reject
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}


########################################################
LOGIN
########################################################

import { useState } from "react";
import GLOBAL from "../GLOBAL.jpg";

function Login() {
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");

  const handleLogin = async (e) => {
    e.preventDefault();

    try {
      const formData = new FormData();
      formData.append("username", username);
      formData.append("password", password);

      const res = await fetch("http://127.0.0.1:8000/auth/login", {
        method: "POST",
        body: formData,
      });

      if (!res.ok) {
        throw new Error("Invalid username or password");
      }

      const data = await res.json();
      localStorage.setItem("user", JSON.stringify(data));
      window.location.href = "/dashboard";
    } catch (err) {
      setError(err.message);
    }
  };

  return (
    <div
      style={{
        backgroundColor: "white",
        color: "black",
        minHeight: "100vh",
        display: "flex",
        flexDirection: "column",
        justifyContent: "center",
        alignItems: "center",
        padding: 20,
      }}
    >
      {/* Centered Header */}
      <div
        style={{
          display: "flex",
          flexDirection: "column",
          alignItems: "center",
          textAlign: "center",
          marginBottom: 30,
          borderBottom: "1px solid #ccc",
          paddingBottom: 20,
          width: "100%",
          maxWidth: 600,
        }}
      >
        <div style={{ marginBottom: 15 }}>
          <img src={GLOBAL} alt="Logo" style={{ height: 60 }} />
        </div>
        <div style={{ lineHeight: 1.4 }}>
          <h1 style={{ margin: "0 0 10px 0", fontSize: 24 }}>Global Engineering Laboratory</h1>
          <p style={{ margin: 0, fontSize: 12 }}>
            P.O.Box 31758 ‚Äì Dubai, U.A.E, Tel: +971 4 3205363, Fax: +971 4 3205373, e-mail: glab@eim.ae
          </p>
        </div>
      </div>

      {/* Login Form */}
      <div
        style={{
          width: "100%",
          maxWidth: 400,
          padding: 30,
          border: "1px solid #ccc",
          borderRadius: 8,
          boxShadow: "0 0 10px rgba(0,0,0,0.1)",
          backgroundColor: "white",
        }}
      >
        <h2 style={{ textAlign: "center", marginBottom: 20 }}>Login</h2>

        {error && (
          <p style={{ 
            color: "red", 
            textAlign: "center", 
            backgroundColor: "#ffe6e6",
            padding: 10,
            borderRadius: 4,
            marginBottom: 15
          }}>
            {error}
          </p>
        )}

        <form onSubmit={handleLogin}>
          <div style={{ marginBottom: 15 }}>
            <input
              type="text"
              placeholder="Username"
              value={username}
              onChange={(e) => setUsername(e.target.value)}
              style={{ 
                width: "100%", 
                padding: 12, 
                border: "1px solid #ddd",
                borderRadius: 4,
                boxSizing: "border-box"
              }}
              required
            />
          </div>
          <div style={{ marginBottom: 20 }}>
            <input
              type="password"
              placeholder="Password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              style={{ 
                width: "100%", 
                padding: 12, 
                border: "1px solid #ddd",
                borderRadius: 4,
                boxSizing: "border-box"
              }}
              required
            />
          </div>
          <button 
            type="submit" 
            style={{ 
              width: "100%", 
              padding: 12, 
              backgroundColor: "#007bff",
              color: "white",
              border: "none",
              borderRadius: 4,
              cursor: "pointer",
              fontSize: 16
            }}
          >
            Login
          </button>
        </form>
      </div>
    </div>
  );
}

export default Login;

########################################################
INVOICES
########################################################

// src/components/invoices/GenerateInvoice.jsx
import { useState, useEffect } from "react";
import axios from "axios";

export default function GenerateInvoice() {
  const [formData, setFormData] = useState({
    project_id: "",
    invoice_type: "CASH"
  });
  const [availableProjects, setAvailableProjects] = useState([]);
  const [loading, setLoading] = useState(false);
  const [invoiceLoading, setInvoiceLoading] = useState(false);
  const [message, setMessage] = useState("");
  const [selectedProjectData, setSelectedProjectData] = useState(null);

  // Fetch latest projects
  useEffect(() => {
    fetchAvailableProjects();
  }, []);

  const fetchAvailableProjects = async () => {
    setLoading(true);
    try {
      const response = await axios.get("http://localhost:8000/invoices/projects/latest/");
      setAvailableProjects(response.data);
    } catch (error) {
      console.error("Error fetching projects:", error);
      setMessage("‚ùå Failed to load projects. Please try again.");
    } finally {
      setLoading(false);
    }
  };

  const handleProjectChange = (e) => {
    const projectId = e.target.value;
    setFormData({ ...formData, project_id: projectId });
    
    const project = availableProjects.find(p => p.project_id == projectId);
    setSelectedProjectData(project || null);
  };

  const handleGenerateInvoice = async (e) => {
    e.preventDefault();
    
    if (!formData.project_id) {
      setMessage("‚ùå Please select a project first");
      return;
    }

    setInvoiceLoading(true);
    setMessage("");

    try {
      // Step 1: Create invoice
      const invoicePayload = {
        project_id: parseInt(formData.project_id),
        invoice_type: formData.invoice_type,
        invoice_date: new Date().toISOString().split('T')[0],
        payment_terms: formData.invoice_type === "CREDIT" ? "30 days" : "Immediate",
        services_description: "Professional services rendered"
      };

      const createResponse = await axios.post(
        "http://localhost:8000/invoices/",
        invoicePayload
      );

      const invoiceId = createResponse.data.invoice_id;
      const invoiceNo = createResponse.data.invoice_no;
      const projectName = createResponse.data.project_details?.project_name || '';
      const lpoNumber = createResponse.data.lpo_reference || '';
      
      console.log("Invoice creation response:", {
        invoiceNo,
        projectName,
        lpoNumber,
        projectDetails: createResponse.data.project_details
      });
      
      // Step 2: Generate Excel
      const excelResponse = await axios.get(
        `http://localhost:8000/invoices/${invoiceId}/excel`,
        { 
          responseType: 'blob'
        }
      );

      // DEBUG: Log headers to see what's being sent
      console.log("=== DEBUG HEADERS ===");
      console.log("All response headers:", excelResponse.headers);
      console.log("Content-Disposition header:", excelResponse.headers['content-disposition']);
      console.log("==========================");
      
      // Step 3: Extract filename from headers
      let filename = `${invoiceNo.replace('/', '-')}.xlsx`; // Default filename
      let gotFilenameFromHeader = false;
      
      // Try to get filename from content-disposition header
      const contentDisposition = excelResponse.headers['content-disposition'];
      if (contentDisposition) {
        console.log("Raw content-disposition:", contentDisposition);
        
        // Try UTF-8 encoded filename first (filename*=UTF-8''...)
        const utf8Match = /filename\*=UTF-8''([^;]+)/i.exec(contentDisposition);
        if (utf8Match && utf8Match[1]) {
          filename = decodeURIComponent(utf8Match[1]);
          gotFilenameFromHeader = true;
          console.log("Got UTF-8 filename from header:", filename);
        } else {
          // Try simple filename extraction (filename="...")
          const simpleMatch = /filename="([^"]+)"/i.exec(contentDisposition);
          if (simpleMatch && simpleMatch[1]) {
            filename = simpleMatch[1];
            gotFilenameFromHeader = true;
            console.log("Got simple filename from header:", filename);
          }
        }
      }
      
      // If we didn't get a proper filename from header or it's just the basic one
      if (!gotFilenameFromHeader || filename === `${invoiceNo.replace('/', '-')}.xlsx`) {
        console.log("Creating filename manually...");
        // Clean the strings for filename
        const cleanProjectName = projectName
          .replace(/[\\/*?:"<>|]/g, '-')
          .replace(/\s+/g, '-')
          .trim('-');
          
        const cleanLpoNumber = lpoNumber && lpoNumber !== ' - ' && lpoNumber !== ''
          ? lpoNumber
              .replace(/[\\/*?:"<>|]/g, '-')
              .replace(/\s+/g, '-')
              .trim('-')
          : '';
        
        // Build filename
        filename = `${invoiceNo.replace('/', '-')}`;
        if (cleanProjectName) {
          filename += `-${cleanProjectName}`;
        }
        if (cleanLpoNumber) {
          filename += `-${cleanLpoNumber}`;
        }
        filename += '.xlsx';
        
        console.log("Manually created filename:", filename);
      }
      
      console.log("Final filename to download:", filename);

      // Step 4: Trigger download
      const url = window.URL.createObjectURL(new Blob([excelResponse.data]));
      const link = document.createElement('a');
      link.href = url;
      
      link.setAttribute('download', filename);
      document.body.appendChild(link);
      link.click();
      link.remove();
      
      window.URL.revokeObjectURL(url);
      
      setMessage(`‚úÖ Invoice ${invoiceNo} generated and downloaded successfully as "${filename}"!`);
      
    } catch (error) {
      console.error("Error generating invoice:", error);
      
      let errorMsg = "‚ùå An unexpected error occurred";
      if (error.response) {
        errorMsg = `‚ùå ${error.response.data?.detail || error.response.statusText}`;
      } else if (error.request) {
        errorMsg = "‚ùå Network error. Please check if the server is running.";
      } else {
        errorMsg = `‚ùå ${error.message}`;
      }
      
      setMessage(errorMsg);
    } finally {
      setInvoiceLoading(false);
    }
  };

  const handlePreviewInvoice = async () => {
    if (!formData.project_id) {
      setMessage("‚ùå Please select a project first");
      return;
    }

    setInvoiceLoading(true);
    setMessage("");

    try {
      const invoicePayload = {
        project_id: parseInt(formData.project_id),
        invoice_type: formData.invoice_type,
        invoice_date: new Date().toISOString().split('T')[0],
        payment_terms: formData.invoice_type === "CREDIT" ? "30 days" : "Immediate"
      };

      const createResponse = await axios.post("http://localhost:8000/invoices/", invoicePayload);
      const invoiceId = createResponse.data.invoice_id;
      const invoiceNo = createResponse.data.invoice_no;
      
      const invoiceDetails = await axios.get(`http://localhost:8000/invoices/${invoiceId}`);
      
      alert(`Invoice Preview Created!\n\nInvoice No: ${invoiceNo}\nType: ${formData.invoice_type}\nStatus: Draft\n\nClick "Generate & Download" to create the final invoice.`);
      
    } catch (error) {
      console.error("Error previewing invoice:", error);
      setMessage("‚ùå Failed to create invoice preview");
    } finally {
      setInvoiceLoading(false);
    }
  };

  return (
    <div className="module-content">
      <div className="module-header">
        <h2>Generate Invoice</h2>
      </div>
      
      <div className="form-section">
        <h3>Generate Invoice from Project</h3>
        
        {message && (
          <div className={`message ${message.includes('‚úÖ') ? 'success' : 'error'}`}>
            {message}
          </div>
        )}

        <form onSubmit={handleGenerateInvoice} className="sample-form">
          {/* SELECT PROJECT */}
          <div className="form-group">
            <label htmlFor="project-id">Select Project *</label>
            <select
              id="project-id"
              value={formData.project_id}
              onChange={handleProjectChange}
              className="form-input"
              required
              disabled={invoiceLoading || loading}
            >
              <option value="">Select a Project</option>
              {availableProjects.map((project) => (
                <option key={project.project_id} value={project.project_id}>
                  {project.label}
                </option>
              ))}
            </select>
            <small className="field-hint">
              Select a project to generate invoice
            </small>
          </div>

          {/* SELECTED PROJECT DETAILS */}
          {selectedProjectData && (
            <div className="selected-project-details">
              <h4>Selected Project Details</h4>
              <div className="details-grid">
                <div className="detail-card">
                  <p className="detail-label">üìÅ Project No</p>
                  <p className="detail-value">{selectedProjectData.project_no}</p>
                </div>
                <div className="detail-card">
                  <p className="detail-label">üë§ Client</p>
                  <p className="detail-value">{selectedProjectData.client_name}</p>
                </div>
                <div className="detail-card">
                  <p className="detail-label">üìç Location</p>
                  <p className="detail-value">{selectedProjectData.location}</p>
                </div>
              </div>
            </div>
          )}

          {/* INVOICE TYPE */}
          <div className="form-group">
            <label>Invoice Type *</label>
            <div className="invoice-type-buttons">
              {[
                { value: "CASH", label: "üíµ Cash Invoice" },
                { value: "CREDIT", label: "üí≥ Credit Invoice" }
              ].map((type) => (
                <button
                  key={type.value}
                  type="button"
                  onClick={() => setFormData({...formData, invoice_type: type.value})}
                  className={`invoice-type-btn ${
                    formData.invoice_type === type.value ? "active" : ""
                  }`}
                >
                  {type.label}
                </button>
              ))}
            </div>
          </div>

          {/* ACTION BUTTONS */}
          <div className="action-buttons">
            <button 
              type="submit" 
              className="btn-primary"
              disabled={invoiceLoading || !formData.project_id}
            >
              {invoiceLoading ? (
                <>
                  <span className="spinner"></span>
                  Generating Invoice...
                </>
              ) : (
                "Generate & Download Invoice"
              )}
            </button>

            <button
              type="button"
              onClick={handlePreviewInvoice}
              className="btn-secondary"
              disabled={invoiceLoading || !formData.project_id}
            >
              Preview Invoice
            </button>
          </div>
        </form>

        {/* PROCESS STEPS */}
        <div className="process-steps">
          <h4>What happens next?</h4>
          <div className="steps-grid">
            {[
              { step: 1, title: "Invoice Created", desc: "Record is saved in database" },
              { step: 2, title: "Excel Generated", desc: "Invoice Excel file created" },
              { step: 3, title: "Automatic Download", desc: "File downloads automatically" }
            ].map(({ step, title, desc }) => (
              <div key={step} className="step-card">
                <div className="step-number">{step}</div>
                <div className="step-content">
                  <p className="step-title">{title}</p>
                  <p className="step-desc">{desc}</p>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* AVAILABLE PROJECTS INFO */}
        {availableProjects.length > 0 && (
          <div className="info-section">
            <h4>Available Projects</h4>
            <div className="projects-list">
              {availableProjects.map(project => (
                <div key={project.project_id} className="project-item">
                  <strong>{project.project_no}</strong> - {project.client_name}
                  {project.status && (
                    <span className={`status-badge ${project.status.toLowerCase()}`}>
                      {project.status}
                    </span>
                  )}
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

########################################################
CREATE PROJECT
########################################################
import { useState, useEffect } from "react";

export default function CreateProject() {
  const [formData, setFormData] = useState({
    quotation_id: '',
    project_name: '',
    location: '',
    lpo_no: '',
    lpo_date: ''
  });

  const [approvedQuotations, setApprovedQuotations] = useState([]);
  const [selectedQuotation, setSelectedQuotation] = useState(null);
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState('');
  const [lpoFile, setLpoFile] = useState(null); // Track LPO file separately
  const [lastCreatedProjectId, setLastCreatedProjectId] = useState(null); // Store created project ID

  useEffect(() => {
    fetchApprovedQuotations();
  }, []);

  const fetchApprovedQuotations = async () => {
    try {
      const response = await fetch('http://127.0.0.1:8000/quotations/');
      if (response.ok) {
        const data = await response.json();
        const approved = data.filter(q => q.status === 'APPROVED');
        setApprovedQuotations(approved);
      }
    } catch (error) {
      console.error("Failed to fetch quotations:", error);
    }
  };

  const handleChange = async (e) => {
    const { name, value } = e.target;

    setFormData(prev => ({
      ...prev,
      [name]: value
    }));

    if (name === 'quotation_id' && value) {
      const quotation = approvedQuotations.find(q => q.quotation_id === parseInt(value));
      if (quotation) {
        setSelectedQuotation(quotation);

        try {
          const response = await fetch(`http://127.0.0.1:8000/quotations/${quotation.quotation_id}`);
          if (response.ok) {
            const quotationDetails = await response.json();

            setFormData(prev => ({
              ...prev,
              project_name: quotationDetails.project_name || '',
              location: quotationDetails.location || ''
            }));
          }
        } catch (error) {
          console.error('Failed to fetch quotation details:', error);
        }
      }
    }
  };

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    setLpoFile(file);
  };

  const uploadLPOFile = async (projectId) => {
    if (!lpoFile) {
      return { success: true, message: "No LPO file to upload" };
    }

    const uploadForm = new FormData();
    uploadForm.append("file", lpoFile);

    try {
      const response = await fetch(
        `http://127.0.0.1:8000/projects/${projectId}/upload-lpo`,
        { method: "POST", body: uploadForm }
      );

      if (response.ok) {
        const result = await response.json();
        return { 
          success: true, 
          message: `‚úÖ LPO uploaded: ${result.file_name}` 
        };
      } else {
        const error = await response.json();
        return { 
          success: false, 
          message: `‚ùå LPO upload failed: ${error.detail}` 
        };
      }
    } catch (error) {
      return { 
        success: false, 
        message: `‚ùå Network error: ${error.message}` 
      };
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    setLoading(true);
    setMessage('');

    try {
      // 1. Create the project first
      const payload = {
        quotation_id: parseInt(formData.quotation_id),
        project_name: formData.project_name,
        location: formData.location,
        lpo_no: formData.lpo_no || undefined,
        lpo_date: formData.lpo_date || undefined
      };

      const createResponse = await fetch('http://127.0.0.1:8000/projects/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!createResponse.ok) {
        const error = await createResponse.json();
        setMessage(`‚ùå Project creation failed: ${error.detail}`);
        setLoading(false);
        return;
      }

      const projectData = await createResponse.json();
      const projectId = projectData.project_id;
      setLastCreatedProjectId(projectId);

      let finalMessage = `‚úÖ Project created successfully! Number: ${projectData.project_no}`;

      // 2. If LPO file exists, upload it
      if (lpoFile) {
        const uploadResult = await uploadLPOFile(projectId);
        finalMessage += `\n${uploadResult.message}`;
      }

      setMessage(finalMessage);

      // 3. Reset form
      setFormData({
        quotation_id: '',
        project_name: '',
        location: '',
        lpo_no: '',
        lpo_date: ''
      });
      setLpoFile(null);
      setSelectedQuotation(null);

    } catch (error) {
      setMessage(`‚ùå Network error: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="module-content">
      <div className="module-header">
        <h2>Create New Project</h2>
      </div>

      {message && (
        <div className={`message ${message.includes('‚úÖ') ? 'success' : 'error'}`}>
          {message.split('\n').map((line, i) => (
            <div key={i}>{line}</div>
          ))}
        </div>
      )}

      <form onSubmit={handleSubmit} className="project-form">
        <div className="form-grid">
          <div className="form-group">
            <label htmlFor="quotation_id">Select Approved Quotation *</label>
            <select
              id="quotation_id"
              name="quotation_id"
              value={formData.quotation_id}
              onChange={handleChange}
              required
              className="form-input"
            >
              <option value="">Select an approved quotation</option>
              {approvedQuotations.map((quotation) => (
                <option key={quotation.quotation_id} value={quotation.quotation_id}>
                  {quotation.quotation_no} - {quotation.client_name} - {quotation.project_name}
                </option>
              ))}
            </select>
            <small className="field-hint">
              Only approved quotations can be converted to projects
            </small>
          </div>

          {selectedQuotation && (
            <>
              <div className="form-group">
                <label htmlFor="project_name">Project Name *</label>
                <input
                  type="text"
                  id="project_name"
                  name="project_name"
                  value={formData.project_name}
                  onChange={handleChange}
                  required
                  placeholder="Enter project name"
                  className="form-input"
                />
                <small className="field-hint">Auto-filled from quotation</small>
              </div>

              <div className="form-group">
                <label htmlFor="location">Location *</label>
                <input
                  type="text"
                  id="location"
                  name="location"
                  value={formData.location}
                  onChange={handleChange}
                  required
                  placeholder="Enter location"
                  className="form-input"
                />
                <small className="field-hint">Auto-filled from quotation</small>
              </div>

              <div className="form-group">
                <label htmlFor="lpo_no">LPO Number</label>
                <input
                  type="text"
                  id="lpo_no"
                  name="lpo_no"
                  value={formData.lpo_no}
                  onChange={handleChange}
                  placeholder="Enter LPO number"
                  className="form-input"
                />
              </div>

              <div className="form-group">
                <label htmlFor="lpo_date">LPO Date</label>
                <input
                  type="date"
                  id="lpo_date"
                  name="lpo_date"
                  value={formData.lpo_date}
                  onChange={handleChange}
                  className="form-input"
                />
              </div>

              <div className="form-group full-width">
                <label htmlFor="lpo_file">Upload LPO Document</label>
                <input
                  type="file"
                  id="lpo_file"
                  name="lpo_file"
                  onChange={handleFileChange}
                  accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                  className="form-input"
                />
                <small className="field-hint">
                  Supported formats: PDF, Word, Images
                  {lpoFile && ` - Selected: ${lpoFile.name}`}
                </small>
              </div>
            </>
          )}
        </div>

        <div className="form-actions">
          <button
            type="submit"
            disabled={loading || !formData.quotation_id}
            className="btn-primary"
          >
            {loading ? 'Creating Project...' : 'Create Project & Upload LPO'}
          </button>
        </div>
      </form>

      {selectedQuotation && (
        <div
          className="quotation-preview"
          style={{
            marginTop: '20px',
            padding: '15px',
            background: '#f8f9fa',
            borderRadius: '8px',
            border: '1px solid #e9ecef'
          }}
        >
          <h4>Selected Quotation Details</h4>
          <div className="info-grid">
            <div className="info-item">
              <label>Quotation No:</label>
              <span>{selectedQuotation.quotation_no}</span>
            </div>
            <div className="info-item">
              <label>Client:</label>
              <span>{selectedQuotation.client_name}</span>
            </div>
            <div className="info-item">
              <label>Division:</label>
              <span>{selectedQuotation.division}</span>
            </div>
            <div className="info-item">
              <label>Total Amount:</label>
              <span>${selectedQuotation.grand_total?.toFixed(2)}</span>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}


########################################################
VIEW PROJECT
########################################################
// src/components/projects/ViewProjects.jsx - WITH VIEW MODE
import { useState, useEffect } from "react";

export default function ViewProjects() {
  const [projects, setProjects] = useState([]);
  const [loading, setLoading] = useState(true);
  const [message, setMessage] = useState('');
  const [editingProject, setEditingProject] = useState(null);
  const [viewingProject, setViewingProject] = useState(null);
  const [editForm, setEditForm] = useState({
    project_name: '',
    lpo_no: '',
    lpo_date: ''
  });
  const [selectedFiles, setSelectedFiles] = useState({});
  const [uploading, setUploading] = useState(false);

  useEffect(() => {
    fetchProjects();
  }, []);

  const fetchProjects = async () => {
    try {
      setLoading(true);
      const response = await fetch('http://127.0.0.1:8000/projects/projects');
      if (response.ok) {
        const data = await response.json();
        setProjects(data);
        setMessage('');
      } else {
        const error = await response.text();
        setMessage('‚ùå Failed to fetch projects');
      }
    } catch (error) {
      setMessage(`‚ùå Network error: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  const handleViewProject = async (project) => {
    try {
      // Fetch full project details for the view
      const response = await fetch(`http://127.0.0.1:8000/projects/${project.project_id}`);
      if (response.ok) {
        const projectDetails = await response.json();
        setViewingProject(projectDetails);
      } else {
        setMessage('‚ùå Failed to fetch project details');
      }
    } catch (error) {
      setMessage(`‚ùå Network error: ${error.message}`);
    }
  };

  const handleCloseView = () => {
    setViewingProject(null);
  };

  const handleEditProject = (project) => {
    setEditingProject(project);
    setEditForm({
      project_name: project.project_name || '',
      lpo_no: project.lpo_no || '',
      lpo_date: project.lpo_date || ''
    });
    setSelectedFiles(prev => ({ ...prev, [project.project_id]: null }));
  };

  const handleCancelEdit = () => {
    setEditingProject(null);
    setEditForm({
      project_name: '',
      lpo_no: '',
      lpo_date: ''
    });
  };

  const handleUpdateProject = async (e) => {
    e.preventDefault();
    if (!editingProject) return;

    try {
      const payload = {
        quotation_id: editingProject.quotation_id,
        project_name: editForm.project_name,
        location: editingProject.location,
        lpo_no: editForm.lpo_no || undefined,
        lpo_date: editForm.lpo_date || undefined
      };

      const response = await fetch(`http://127.0.0.1:8000/projects/${editingProject.project_id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });

      if (response.ok) {
        const data = await response.json();
        setMessage('‚úÖ Project updated successfully!');
        setEditingProject(null);
        fetchProjects();
      } else {
        const error = await response.json();
        setMessage(`‚ùå Error: ${error.detail}`);
      }
    } catch (error) {
      setMessage(`‚ùå Network error: ${error.message}`);
    }
  };

  const handleFileSelect = (projectId, file) => {
    if (file) {
      setSelectedFiles(prev => ({
        ...prev,
        [projectId]: file
      }));
    }
  };

  const handleFileUpload = async (projectId) => {
    const file = selectedFiles[projectId];
    if (!file) {
      setMessage('‚ùå Please select a file first');
      return;
    }

    setUploading(true);
    const uploadFormData = new FormData();
    uploadFormData.append('file', file);

    try {
      setMessage('üì§ Uploading file...');
      const response = await fetch(`http://127.0.0.1:8000/projects/${projectId}/upload-lpo`, {
        method: 'POST',
        body: uploadFormData,
      });

      if (response.ok) {
        const result = await response.json();
        setMessage(`‚úÖ LPO file uploaded successfully: ${result.file_name}`);
        
        setSelectedFiles(prev => ({
          ...prev,
          [projectId]: null
        }));
        
        fetchProjects();
      } else {
        const error = await response.json();
        setMessage(`‚ùå Failed to upload LPO: ${error.detail}`);
      }
    } catch (error) {
      setMessage(`‚ùå Network error during upload: ${error.message}`);
    } finally {
      setUploading(false);
    }
  };

  const downloadLPO = (projectId) => {
    window.open(`http://127.0.0.1:8000/projects/${projectId}/download-lpo`, '_blank');
  };

  // Project Details View Component
  const ProjectDetailsView = ({ project, onClose }) => {
    return (
      <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        backgroundColor: 'rgba(0,0,0,0.5)',
        display: 'flex',
        justifyContent: 'center',
        alignItems: 'center',
        zIndex: 1000
      }}>
        <div style={{
          background: 'white',
          padding: '24px',
          borderRadius: '8px',
          width: '90%',
          maxWidth: '500px',
          maxHeight: '90vh',
          overflow: 'auto',
          boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
        }}>
          <div style={{
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            marginBottom: '20px',
            borderBottom: '1px solid #e0e0e0',
            paddingBottom: '15px'
          }}>
            <h2 style={{ margin: 0, color: '#333' }}>Project Details</h2>
            <button 
              onClick={onClose}
              style={{
                background: 'none',
                border: 'none',
                fontSize: '24px',
                cursor: 'pointer',
                color: '#666'
              }}
            >
              √ó
            </button>
          </div>

          <div style={{
            display: 'grid',
            gap: '16px'
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <strong>Project Number:</strong>
              <span>{project.project_no}</span>
            </div>
            
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <strong>Project Name:</strong>
              <span>{project.project_name}</span>
            </div>
            
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <strong>Client:</strong>
              <span>{project.client_name || 'N/A'}</span>
            </div>
            
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <strong>Location:</strong>
              <span>{project.location}</span>
            </div>
            
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <strong>Quotation No:</strong>
              <span>{project.quotation_no || 'N/A'}</span>
            </div>
            
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <strong>LPO Number:</strong>
              <span>{project.lpo_no || '-'}</span>
            </div>
            
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <strong>LPO Date:</strong>
              <span>{project.lpo_date || '-'}</span>
            </div>
            
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <strong>Status:</strong>
              <span style={{
                padding: '4px 12px',
                borderRadius: '12px',
                fontSize: '12px',
                fontWeight: 'bold',
                backgroundColor: project.status === 'ACTIVE' ? '#d4edda' : '#f8d7da',
                color: project.status === 'ACTIVE' ? '#155724' : '#721c24'
              }}>
                {project.status}
              </span>
            </div>

            {/* LPO File Section */}
            <div style={{
              marginTop: '20px',
              padding: '16px',
              backgroundColor: '#f8f9fa',
              borderRadius: '6px',
              border: '1px solid #e9ecef'
            }}>
              <strong style={{ display: 'block', marginBottom: '8px' }}>LPO Document:</strong>
              {project.lpo_file ? (
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <span style={{ 
                    background: '#e9ecef',
                    padding: '6px 12px',
                    borderRadius: '4px',
                    fontSize: '14px',
                    flex: 1
                  }}>
                    {project.lpo_file}
                  </span>
                  <button 
                    onClick={() => downloadLPO(project.project_id)}
                    style={{
                      background: '#007bff',
                      color: 'white',
                      border: 'none',
                      padding: '8px 16px',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      fontSize: '14px',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px'
                    }}
                  >
                    üì• View LPO
                  </button>
                </div>
              ) : (
                <div style={{ color: '#6c757d', fontStyle: 'italic' }}>
                  No LPO document uploaded
                </div>
              )}
            </div>
          </div>

          <div style={{
            marginTop: '24px',
            display: 'flex',
            justifyContent: 'flex-end',
            gap: '12px',
            borderTop: '1px solid #e0e0e0',
            paddingTop: '20px'
          }}>
            <button 
              onClick={onClose}
              style={{
                background: '#6c757d',
                color: 'white',
                border: 'none',
                padding: '10px 20px',
                borderRadius: '6px',
                cursor: 'pointer',
                fontSize: '14px'
              }}
            >
              Close
            </button>
          </div>
        </div>
      </div>
    );
  };

  if (loading) {
    return (
      <div className="module-content">
        <div className="loading">Loading projects...</div>
      </div>
    );
  }

  // Show project details view if viewing
  if (viewingProject) {
    return <ProjectDetailsView project={viewingProject} onClose={handleCloseView} />;
  }

  return (
    <div className="module-content">
      <div className="module-header">
        <div>
          <h2>All Projects</h2>
          <div className="project-count">
            {projects.length} project{projects.length !== 1 ? 's' : ''} found
          </div>
        </div>
        <button onClick={() => window.location.href = '/projects/create'}>
          + Create New Project
        </button>
      </div>

      {message && (
        <div className={`message ${message.includes('‚úÖ') ? 'success' : 'error'}`}>
          {message}
        </div>
      )}

      <button onClick={fetchProjects}>üîÑ Refresh List</button>

      {projects.length === 0 ? (
        <div className="no-data">
          <h3>No Projects Found</h3>
          <button onClick={() => window.location.href = '/projects/create'}>
            + Create First Project
          </button>
        </div>
      ) : (
        <div className="projects-table-container">
          <table className="projects-table">
            <thead>
              <tr>
                <th>Project No</th>
                <th>Project Name</th>
                <th>Client</th>
                <th>Location</th>
                <th>Quotation No</th>
                <th>LPO No</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>

<tbody>
  {projects.map((project) => (
    <tr key={project.project_id}>
      <td>{project.project_no}</td>
      
      <td>
        {editingProject?.project_id === project.project_id ? (
          <input
            type="text"
            value={editForm.project_name}
            onChange={(e) => setEditForm({...editForm, project_name: e.target.value})}
            style={{ 
              padding: '6px', 
              border: '1px solid #ccc', 
              borderRadius: '4px',
              width: '100%',
              fontSize: '14px'
            }}
          />
        ) : (
          project.project_name
        )}
      </td>
      
      <td>{project.client_name || 'N/A'}</td>
      <td>{project.location}</td>
      <td>{project.quotation_no || 'N/A'}</td>
      
      <td>
        {editingProject?.project_id === project.project_id ? (
          <input
            type="text"
            value={editForm.lpo_no}
            onChange={(e) => setEditForm({...editForm, lpo_no: e.target.value})}
            placeholder="Enter LPO number"
            style={{ 
              padding: '6px', 
              border: '1px solid #ccc', 
              borderRadius: '4px',
              width: '100%',
              fontSize: '14px'
            }}
          />
        ) : (
          project.lpo_no || '-'
        )}
      </td>
      
      <td>
        <span style={{
          padding: '4px 8px',
          borderRadius: '12px',
          fontSize: '12px',
          fontWeight: 'bold',
          backgroundColor: project.status === 'ACTIVE' ? '#d4edda' : '#f8d7da',
          color: project.status === 'ACTIVE' ? '#155724' : '#721c24'
        }}>
          {project.status}
        </span>
      </td>
      
      <td>
        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', minWidth: '200px' }}>
          {editingProject?.project_id === project.project_id ? (
            <>
              {/* Edit Form Actions */}
              <div style={{ display: 'flex', gap: '4px' }}>
                <button 
                  onClick={handleUpdateProject}
                  style={{
                    background: '#28a745',
                    color: 'white',
                    border: 'none',
                    padding: '8px 12px',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontSize: '12px',
                    flex: 1
                  }}
                >
                  ‚úÖ Save
                </button>
                <button 
                  onClick={handleCancelEdit}
                  style={{
                    background: '#6c757d',
                    color: 'white',
                    border: 'none',
                    padding: '8px 12px',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontSize: '12px',
                    flex: 1
                  }}
                >
                  ‚ùå Cancel
                </button>
              </div>

              {/* File Upload Section */}
              <div style={{ 
                border: '1px solid #e0e0e0', 
                padding: '12px', 
                borderRadius: '6px',
                backgroundColor: '#f8f9fa'
              }}>
                <div style={{ marginBottom: '12px' }}>
                  <label style={{
                    display: 'block',
                    background: '#007bff',
                    color: 'white',
                    border: 'none',
                    padding: '8px 12px',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontSize: '12px',
                    textAlign: 'center',
                    marginBottom: '8px'
                  }}>
                    üìé Choose LPO File
                    <input
                      type="file"
                      onChange={(e) => handleFileSelect(project.project_id, e.target.files[0])}
                      style={{ display: 'none' }}
                      accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                    />
                  </label>
                  
                  {/* Show selected file name */}
                  {selectedFiles[project.project_id] && (
                    <div style={{
                      fontSize: '12px',
                      color: '#28a745',
                      fontWeight: 'bold',
                      textAlign: 'center',
                      padding: '4px',
                      backgroundColor: '#d4edda',
                      borderRadius: '4px'
                    }}>
                      ‚úÖ Selected: {selectedFiles[project.project_id].name}
                    </div>
                  )}
                </div>

                {/* Upload Button */}
                {selectedFiles[project.project_id] && (
                  <button 
                    onClick={() => handleFileUpload(project.project_id)}
                    disabled={uploading}
                    style={{
                      background: uploading ? '#6c757d' : '#28a745',
                      color: 'white',
                      border: 'none',
                      padding: '8px 12px',
                      borderRadius: '4px',
                      cursor: uploading ? 'not-allowed' : 'pointer',
                      fontSize: '12px',
                      width: '100%',
                      marginBottom: '8px'
                    }}
                  >
                    {uploading ? '‚¨ÜÔ∏è Uploading...' : '‚¨ÜÔ∏è Upload File'}
                  </button>
                )}

                {/* Download Button for existing files */}
                {project.lpo_file && (
                  <button 
                    onClick={() => downloadLPO(project.project_id)}
                    style={{
                      background: '#17a2b8',
                      color: 'white',
                      border: 'none',
                      padding: '8px 12px',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      fontSize: '12px',
                      width: '100%'
                    }}
                  >
                    üì• Download LPO
                  </button>
                )}
              </div>

              {/* LPO Date Input */}
              <div>
                <label style={{ fontSize: '12px', fontWeight: 'bold', display: 'block', marginBottom: '4px' }}>
                  LPO Date:
                </label>
                <input
                  type="date"
                  value={editForm.lpo_date}
                  onChange={(e) => setEditForm({...editForm, lpo_date: e.target.value})}
                  style={{ 
                    padding: '6px', 
                    border: '1px solid #ccc', 
                    borderRadius: '4px',
                    width: '100%',
                    fontSize: '12px'
                  }}
                />
              </div>
            </>
          ) : (
            /* View Mode - View & Edit Buttons */
            <div style={{ display: 'flex', gap: '8px' }}>
              <button 
                onClick={() => handleViewProject(project)}
                style={{
                  background: '#17a2b8',
                  color: 'white',
                  border: 'none',
                  padding: '8px 12px',
                  borderRadius: '4px',
                  cursor: 'pointer',
                  fontSize: '12px',
                  flex: 1,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '4px'
                }}
              >
                üëÅ View
              </button>

              <button 
                onClick={() => handleEditProject(project)}
                style={{
                  background: '#ffc107',
                  color: '#212529',
                  border: 'none',
                  padding: '8px 12px',
                  borderRadius: '4px',
                  cursor: 'pointer',
                  fontSize: '12px',
                  flex: 1,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '4px'
                }}
              >
                ‚úèÔ∏è Edit
              </button>
            </div>
          )}
        </div>
      </td>
    </tr>
  ))}
</tbody>
          </table>
        </div>
      )}
    </div>
  );
}

########################################################
PROJECT DETAILS
########################################################

// src/components/projects/ProjectDetails.jsx
export default function ProjectDetails({ project, onClose, onEdit }) {
  const downloadLPO = () => {
    if (project.lpo_file) {
      // This would need to be implemented based on your file serving setup
      window.open(`http://127.0.0.1:8000/projects/${project.project_id}/download-lpo`, '_blank');
    }
  };

  return (
    <div className="project-details-overlay">
      <div className="project-details-modal">
        <div className="modal-header">
          <h3>Project Details: {project.project_no}</h3>
          <button onClick={onClose} className="close-btn">√ó</button>
        </div>

        <div className="project-info">
          <div className="info-grid">
            <div className="info-item">
              <label>Project Number:</label>
              <span>{project.project_no}</span>
            </div>
            <div className="info-item">
              <label>Project Name:</label>
              <span>{project.project_name}</span>
            </div>
            <div className="info-item">
              <label>Client:</label>
              <span>{project.client_name || 'N/A'}</span>
            </div>
            <div className="info-item">
              <label>Location:</label>
              <span>{project.location}</span>
            </div>
            <div className="info-item">
              <label>Quotation No:</label>
              <span>{project.quotation_no || 'N/A'}</span>
            </div>
            <div className="info-item">
              <label>LPO Number:</label>
              <span>{project.lpo_no || '-'}</span>
            </div>
            <div className="info-item">
              <label>LPO Date:</label>
              <span>{project.lpo_date || '-'}</span>
            </div>
            <div className="info-item">
              <label>Status:</label>
              <span className={`status-badge status-${project.status?.toLowerCase()}`}>
                {project.status}
              </span>
            </div>
            <div className="info-item full-width">
              <label>LPO Document:</label>
              <div className="lpo-file-section">
                {project.lpo_file ? (
                  <div className="file-info">
                    <span className="file-name">{project.lpo_file}</span>
                    <button onClick={downloadLPO} className="btn-download">
                      üì• Download
                    </button>
                  </div>
                ) : (
                  <span className="no-file">No LPO document uploaded</span>
                )}
              </div>
            </div>
          </div>
        </div>

        <div className="modal-actions">
          <button onClick={onEdit} className="btn-primary">
            ‚úèÔ∏è Edit Project
          </button>
          <button onClick={onClose} className="btn-secondary">
            Close
          </button>
        </div>
      </div>
    </div>
  );
}

########################################################
APPROVED QUOTATION
########################################################

// src/components/quotations/ApprovedQuotations.jsx
import { useState, useEffect } from "react";
import QuotationList from "./QuotationList";

export default function ApprovedQuotations() {
  const [quotations, setQuotations] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchQuotations();
  }, []);

  const fetchQuotations = async () => {
    try {
      const response = await fetch('http://127.0.0.1:8000/quotations/');
      if (response.ok) {
        const data = await response.json();
        const approvedQuotations = data.filter(q => q.status === 'APPROVED');
        setQuotations(approvedQuotations);
      }
    } catch (error) {
      console.error("Failed to fetch quotations:", error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) return <div className="loading">Loading approved quotations...</div>;

  return (
    <div className="module-content">
      <div className="module-header">
        <h2>Approved Quotations</h2>
        <div className="quotation-count">
          {quotations.length} approved quotation{quotations.length !== 1 ? 's' : ''}
        </div>
      </div>

      {quotations.length === 0 ? (
        <div className="no-data">
          <h3>No Approved Quotations</h3>
          <p>Approved quotations will appear here.</p>
        </div>
      ) : (
        <QuotationList quotations={quotations} />
      )}
    </div>
  );
}

########################################################
CREATE QUOTATION 
########################################################


import { useState, useEffect } from "react";

export default function CreateQuotation({ onQuotationCreated }) {
  const [formData, setFormData] = useState({
    enquiry_id: '',
    division: '',
    payment_terms: '', // Changed: will now be dropdown
    prepared_under: '', // Added: new field
    validity_days: 30
  });
  
  const [enquiries, setEnquiries] = useState([]);
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState('');

  // Define dropdown options
  const paymentTermsOptions = [
    { value: '', label: 'Select payment terms' },
    { value: 'CASH', label: 'CASH' },
    { value: 'CREDIT', label: 'CREDIT' },
    { value: '50% Advance, 50% on Completion', label: '50% Advance, 50% on Completion' },
    { value: '30 Days Credit', label: '30 Days Credit' },
    { value: '60 Days Credit', label: '60 Days Credit' },
  ];

  const preparedUnderOptions = [
    { value: '', label: 'Select prepared under' },
    { value: 'AR', label: 'Abdul Razak (AR)' },
    { value: 'AS', label: 'Afroz Shaikh (AS)' },
  ];

  useEffect(() => {
    fetchApprovedEnquiries();
  }, []);

  const fetchApprovedEnquiries = async () => {
    try {
      const response = await fetch('http://127.0.0.1:8000/enquiries/');
      if (response.ok) {
        const data = await response.json();
        const approvedEnquiries = data.filter(enquiry => enquiry.status === 'APPROVED');
        setEnquiries(approvedEnquiries);
      }
    } catch (error) {
      console.error("Failed to fetch enquiries:", error);
    }
  };

  const handleChange = (e) => {
    setFormData({
      ...formData,
      [e.target.name]: e.target.value
    });
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setMessage('');

    try {
      const payload = {
        ...formData,
        enquiry_id: parseInt(formData.enquiry_id),
        validity_days: parseInt(formData.validity_days)
      };

      const response = await fetch('http://127.0.0.1:8000/quotations/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });

      if (response.ok) {
        const data = await response.json();
        const successMessage = `‚úÖ Quotation created successfully! Number: ${data.quotation_no}`;
        setMessage(successMessage);
        
        if (onQuotationCreated) {
          onQuotationCreated(data);
        }
        
        setFormData({
          enquiry_id: '',
          division: '',
          payment_terms: '',
          prepared_under: '', // Reset new field
          validity_days: 30
        });
      } else {
        const error = await response.json();
        setMessage(`‚ùå Error: ${error.detail}`);
      }
    } catch (error) {
      setMessage(`‚ùå Network error: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="module-content">
      <div className="module-header">
        <h2>Create New Quotation</h2>
      </div>

      {message && (
        <div className={`message ${message.includes('‚úÖ') ? 'success' : 'error'}`}>
          {message}
        </div>
      )}

      <form onSubmit={handleSubmit} className="quotation-form">
        <div className="form-grid">
          <div className="form-group">
            <label htmlFor="enquiry_id">Select Approved Enquiry *</label>
            <select
              id="enquiry_id"
              name="enquiry_id"
              value={formData.enquiry_id}
              onChange={handleChange}
              required
              className="form-input"
            >
              <option value="">Select an approved enquiry</option>
              {enquiries.map((enquiry) => (
                <option key={enquiry.enquiry_id} value={enquiry.enquiry_id}>
                  {enquiry.enquiry_ref} - {enquiry.project_name}
                </option>
              ))}
            </select>
            <small className="field-hint">Only approved enquiries can be used for quotations</small>
          </div>

          <div className="form-group">
            <label htmlFor="division">Division *</label>
            <select
              id="division"
              name="division"
              value={formData.division}
              onChange={handleChange}
              required
              className="form-input"
            >
              <option value="">Select division</option>
              <option value="MAT">Material Testing</option>
              <option value="GEO">GeoTechnical</option>
              <option value="NDT">NDT</option>
              <option value="CHM">Chemical</option>
              <option value="BIO">Biological</option>
              <option value="ENV">Environmental</option>
              <option value="SPJ">Special Jobs</option>
              <option value="SRV">Survey</option>
            </select>
          </div>

          <div className="form-group">
            <label htmlFor="validity_days">Validity Days</label>
            <input
              type="number"
              id="validity_days"
              name="validity_days"
              value={formData.validity_days}
              onChange={handleChange}
              min="1"
              max="365"
              className="form-input"
            />
            <small className="field-hint">Default: 30 days</small>
          </div>

          {/* Updated Payment Terms as Dropdown */}
          <div className="form-group">
            <label htmlFor="payment_terms">Payment Terms *</label>
            <select
              id="payment_terms"
              name="payment_terms"
              value={formData.payment_terms}
              onChange={handleChange}
              required
              className="form-input"
            >
              {paymentTermsOptions.map(option => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>

          {/* New Prepared Under Dropdown */}
          <div className="form-group">
            <label htmlFor="prepared_under">Prepared Under *</label>
            <select
              id="prepared_under"
              name="prepared_under"
              value={formData.prepared_under}
              onChange={handleChange}
              required
              className="form-input"
            >
              {preparedUnderOptions.map(option => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>
        </div>

        <div className="form-actions">
          <button type="submit" disabled={loading} className="btn-primary">
            {loading ? 'Creating...' : 'Create Quotation'}
          </button>
        </div>
      </form>
    </div>
  );
}




########################################################
QUOTATION LIST
########################################################

// src/components/quotations/QuotationList.jsx
import { useState } from "react";
import QuotationDetails from "./QuotationDetails";

export default function QuotationList({ quotations, showRevisionOption = false }) {
  const [selectedQuotation, setSelectedQuotation] = useState(null);
  const [showDetails, setShowDetails] = useState(false);

  const fetchQuotationDetails = async (quotationId) => {
    try {
      const response = await fetch(`http://127.0.0.1:8000/quotations/${quotationId}`);
      if (response.ok) {
        const data = await response.json();
        setSelectedQuotation(data);
        setShowDetails(true);
      }
    } catch (error) {
      console.error("Failed to fetch quotation details:", error);
    }
  };

  const createRevision = async (quotationId) => {
    try {
      const response = await fetch(`http://127.0.0.1:8000/quotations/${quotationId}/revision`, {
        method: 'POST',
      });

      if (response.ok) {
        const result = await response.json();
        alert(`Revision created: ${result.new_quotation_no}`);
      }
    } catch (error) {
      console.error("Failed to create revision:", error);
    }
  };

  return (
    <>
      <div className="quotations-table-container">
        <table className="quotations-table">
          <thead>
            <tr>
              <th>Quotation No</th>
              <th>Client</th>
              <th>Enquiry Ref</th>
              <th>Division</th>
              <th>Total Amount</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {quotations.map((quotation) => (
              <tr key={quotation.quotation_id}>
                <td className="quotation-no">{quotation.quotation_no}</td>
                <td className="client-name">{quotation.client_name || 'N/A'}</td>
                <td className="enquiry-ref">{quotation.enquiry_ref || 'N/A'}</td>
                <td className="division">{quotation.division}</td>
                <td className="amount">${quotation.grand_total?.toFixed(2) || '0.00'}</td>
                <td className="actions">
                  <button 
                    onClick={() => fetchQuotationDetails(quotation.quotation_id)} 
                    className="btn-view"
                  >
                    üëÅ View
                  </button>
                  {showRevisionOption && (
                    <button 
                      onClick={() => createRevision(quotation.quotation_id)} 
                      className="btn-revision"
                    >
                      üîÑ Create Revision
                    </button>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {showDetails && selectedQuotation && (
        <QuotationDetails 
          quotation={selectedQuotation} 
          onClose={() => setShowDetails(false)}
        />
      )}
    </>
  );
}


########################################################
REJECTED QUOTATION 
########################################################
// src/components/quotations/RejectedQuotations.jsx
import { useState, useEffect } from "react";
import QuotationList from "./QuotationList";

export default function RejectedQuotations() {
  const [quotations, setQuotations] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchQuotations();
  }, []);

  const fetchQuotations = async () => {
    try {
      const response = await fetch('http://127.0.0.1:8000/quotations/');
      if (response.ok) {
        const data = await response.json();
        const rejectedQuotations = data.filter(q => q.status === 'REJECTED');
        setQuotations(rejectedQuotations);
      }
    } catch (error) {
      console.error("Failed to fetch quotations:", error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) return <div className="loading">Loading rejected quotations...</div>;

  return (
    <div className="module-content">
      <div className="module-header">
        <h2>Rejected Quotations</h2>
        <div className="quotation-count">
          {quotations.length} rejected quotation{quotations.length !== 1 ? 's' : ''}
        </div>
      </div>

      {quotations.length === 0 ? (
        <div className="no-data">
          <h3>No Rejected Quotations</h3>
          <p>Rejected quotations will appear here.</p>
        </div>
      ) : (
        <QuotationList quotations={quotations} />
      )}
    </div>
  );
}



########################################################
REVISIONS CLARIFICATION  
########################################################

// src/components/quotations/RevisionsClarification.jsx
import { useState, useEffect } from "react";
import QuotationList from "./QuotationList";

export default function RevisionsClarification() {
  const [quotations, setQuotations] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchQuotations();
  }, []);

  const fetchQuotations = async () => {
    try {
      const response = await fetch('http://127.0.0.1:8000/quotations/');
      if (response.ok) {
        const data = await response.json();
        const clarificationQuotations = data.filter(q => q.status === 'CLARIFICATION');
        setQuotations(clarificationQuotations);
      }
    } catch (error) {
      console.error("Failed to fetch quotations:", error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) return <div className="loading">Loading quotations requiring clarification...</div>;

  return (
    <div className="module-content">
      <div className="module-header">
        <h2>Revisions & Clarification</h2>
        <div className="quotation-count">
          {quotations.length} quotation{quotations.length !== 1 ? 's' : ''} requiring clarification
        </div>
      </div>

      {quotations.length === 0 ? (
        <div className="no-data">
          <h3>No Quotations Requiring Clarification</h3>
          <p>Quotations needing revision or clarification will appear here.</p>
        </div>
      ) : (
        <QuotationList quotations={quotations} showRevisionOption={true} />
      )}
    </div>
  );
}



########################################################
VIEW QUOTATION 
########################################################

// src/components/quotations/ViewQuotations.jsx
import { useState, useEffect } from "react";
import QuotationDetails from "./QuotationDetails";

export default function ViewQuotations({ onStatusUpdate }) {
  const [quotations, setQuotations] = useState([]);
  const [loading, setLoading] = useState(true);
  const [message, setMessage] = useState('');
  const [selectedQuotation, setSelectedQuotation] = useState(null);
  const [showDetails, setShowDetails] = useState(false);

  useEffect(() => {
    fetchQuotations();
  }, []);

  const fetchQuotations = async () => {
    try {
      const response = await fetch('http://127.0.0.1:8000/quotations/');
      if (response.ok) {
        const data = await response.json();
        setQuotations(data);
        setMessage('');
      } else {
        setMessage('‚ùå Failed to fetch quotations');
      }
    } catch (error) {
      setMessage(`‚ùå Network error: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

const updateQuotationStatus = async (quotationId, action) => {
  try {
    const response = await fetch(
      `http://127.0.0.1:8000/quotations/${quotationId}/${action}`,
      { method: 'POST' }
    );

    if (response.ok) {
      const result = await response.json();

      // ‚úÖ Optimistic UI update
      setQuotations(prev =>
        prev.map(q =>
          q.quotation_id === quotationId
            ? { ...q, status: action.toUpperCase() }
            : q
        )
      );

      setMessage(`‚úÖ Quotation ${result.quotation_no} ${action} successfully`);

      // ‚úÖ Close modal to avoid stale view
      setShowDetails(false);
      setSelectedQuotation(null);

      // ‚úÖ Optional hard refresh from backend
      fetchQuotations();

      if (onStatusUpdate) {
        const statusMap = {
          approve: 'APPROVED',
          reject: 'REJECTED',
          clarification: 'CLARIFICATION',
          send: 'SENT',
          revision: 'REVISION'
        };

        onStatusUpdate(
          result.quotation_no,
          statusMap[action] || action.toUpperCase()
        );
      }
    } else {
      const errorData = await response.json();
      setMessage(`‚ùå Failed to ${action}: ${errorData.detail}`);
    }
  } catch (error) {
    setMessage(`‚ùå Network error: ${error.message}`);
  }
};


  const fetchQuotationDetails = async (quotationId) => {
    try {
      const response = await fetch(`http://127.0.0.1:8000/quotations/${quotationId}`);
      if (response.ok) {
        const data = await response.json();
        setSelectedQuotation(data);
        setShowDetails(true);
      }
    } catch (error) {
      setMessage(`‚ùå Failed to fetch quotation details: ${error.message}`);
    }
  };

  const getStatusBadge = (status) => {
    const statusConfig = {
      'DRAFT': { class: 'draft', label: 'Draft' },
      'SENT': { class: 'sent', label: 'Sent' },
      'APPROVED': { class: 'approved', label: 'Approved' },
      'REJECTED': { class: 'rejected', label: 'Rejected' },
      'CLARIFICATION': { class: 'clarification', label: 'Clarification' }
    };
    
    const config = statusConfig[status] || { class: 'default', label: status };
    return <span className={`status-badge status-${config.class}`}>{config.label}</span>;
  };

  const getActionButtons = (quotation) => {
    switch (quotation.status) {
      case 'DRAFT':
        return (
          <>
            <button onClick={() => updateQuotationStatus(quotation.quotation_id, 'send')} className="btn-send">
              üì§ Send
            </button>
            <button onClick={() => fetchQuotationDetails(quotation.quotation_id)} className="btn-view">
              üëÅ View
            </button>
          </>
        );
      case 'SENT':
        return (
          <>
            <button onClick={() => updateQuotationStatus(quotation.quotation_id, 'approve')} className="btn-approve">
              ‚úÖ Approve
            </button>
            <button onClick={() => updateQuotationStatus(quotation.quotation_id, 'reject')} className="btn-reject">
              ‚ùå Reject
            </button>
            <button onClick={() => updateQuotationStatus(quotation.quotation_id, 'clarification')} className="btn-clarify">
              ‚ùì Clarify
            </button>
            <button onClick={() => fetchQuotationDetails(quotation.quotation_id)} className="btn-view">
              üëÅ View
            </button>
          </>
        );
      case 'CLARIFICATION':
        return (
          <>
            <button onClick={() => updateQuotationStatus(quotation.quotation_id, 'revision')} className="btn-revision">
              üîÑ Revision
            </button>
            <button onClick={() => fetchQuotationDetails(quotation.quotation_id)} className="btn-view">
              üëÅ View
            </button>
          </>
        );
      default:
        return (
          <button onClick={() => fetchQuotationDetails(quotation.quotation_id)} className="btn-view">
            üëÅ View
          </button>
        );
    }
  };

  if (loading) return <div className="loading">Loading quotations...</div>;

  return (
    <div className="module-content">
      <div className="module-header">
        <h2>All Quotations</h2>
        <div className="quotation-count">
          {quotations.length} quotation{quotations.length !== 1 ? 's' : ''}
        </div>
      </div>

      {message && (
        <div className={`message ${message.includes('‚úÖ') ? 'success' : 'error'}`}>
          {message}
        </div>
      )}

      <div className="refresh-section">
        <button onClick={fetchQuotations} className="btn-refresh">
          üîÑ Refresh List
        </button>
      </div>

      {showDetails && selectedQuotation && (
        <QuotationDetails 
          quotation={selectedQuotation} 
          onClose={() => setShowDetails(false)}
          onStatusUpdate={updateQuotationStatus}
        />
      )}

      {quotations.length === 0 ? (
        <div className="no-data">
          <h3>No Quotations Found</h3>
          <p>Create your first quotation to get started.</p>
        </div>
      ) : (
        <div className="quotations-table-container">
          <table className="quotations-table">
            <thead>
              <tr>
                <th>Quotation No</th>
                <th>Client</th>
                <th>Enquiry Ref</th>
                <th>Division</th>
                <th>Revision</th>
                <th>Total Amount</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {quotations.map((quotation) => (
                <tr key={quotation.quotation_id}>
                  <td className="quotation-no">{quotation.quotation_no}</td>
                  <td className="client-name">{quotation.client_name || 'N/A'}</td>
                  <td className="enquiry-ref">{quotation.enquiry_ref || 'N/A'}</td>
                  <td className="division">{quotation.division}</td>
                  <td className="revision">V{quotation.revision}</td>
                  <td className="amount">${quotation.grand_total?.toFixed(2) || '0.00'}</td>
                  <td className="status">{getStatusBadge(quotation.status)}</td>
                  <td className="actions">
                    {getActionButtons(quotation)}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}



########################################################
CREATE PROJECT
########################################################

import { useState, useEffect } from "react";

export default function CreateProject() {
  const [formData, setFormData] = useState({
    quotation_id: '',
    project_name: '',
    location: '',
    lpo_no: '',
    lpo_date: ''
  });

  const [approvedQuotations, setApprovedQuotations] = useState([]);
  const [selectedQuotation, setSelectedQuotation] = useState(null);
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState('');
  const [lpoFile, setLpoFile] = useState(null); // Track LPO file separately
  const [lastCreatedProjectId, setLastCreatedProjectId] = useState(null); // Store created project ID

  useEffect(() => {
    fetchApprovedQuotations();
  }, []);

  const fetchApprovedQuotations = async () => {
    try {
      const response = await fetch('http://127.0.0.1:8000/quotations/');
      if (response.ok) {
        const data = await response.json();
        const approved = data.filter(q => q.status === 'APPROVED');
        setApprovedQuotations(approved);
      }
    } catch (error) {
      console.error("Failed to fetch quotations:", error);
    }
  };

  const handleChange = async (e) => {
    const { name, value } = e.target;

    setFormData(prev => ({
      ...prev,
      [name]: value
    }));

    if (name === 'quotation_id' && value) {
      const quotation = approvedQuotations.find(q => q.quotation_id === parseInt(value));
      if (quotation) {
        setSelectedQuotation(quotation);

        try {
          const response = await fetch(`http://127.0.0.1:8000/quotations/${quotation.quotation_id}`);
          if (response.ok) {
            const quotationDetails = await response.json();

            setFormData(prev => ({
              ...prev,
              project_name: quotationDetails.project_name || '',
              location: quotationDetails.location || ''
            }));
          }
        } catch (error) {
          console.error('Failed to fetch quotation details:', error);
        }
      }
    }
  };

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    setLpoFile(file);
  };

  const uploadLPOFile = async (projectId) => {
    if (!lpoFile) {
      return { success: true, message: "No LPO file to upload" };
    }

    const uploadForm = new FormData();
    uploadForm.append("file", lpoFile);

    try {
      const response = await fetch(
        `http://127.0.0.1:8000/projects/${projectId}/upload-lpo`,
        { method: "POST", body: uploadForm }
      );

      if (response.ok) {
        const result = await response.json();
        return { 
          success: true, 
          message: `‚úÖ LPO uploaded: ${result.file_name}` 
        };
      } else {
        const error = await response.json();
        return { 
          success: false, 
          message: `‚ùå LPO upload failed: ${error.detail}` 
        };
      }
    } catch (error) {
      return { 
        success: false, 
        message: `‚ùå Network error: ${error.message}` 
      };
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    setLoading(true);
    setMessage('');

    try {
      // 1. Create the project first
      const payload = {
        quotation_id: parseInt(formData.quotation_id),
        project_name: formData.project_name,
        location: formData.location,
        lpo_no: formData.lpo_no || undefined,
        lpo_date: formData.lpo_date || undefined
      };

      const createResponse = await fetch('http://127.0.0.1:8000/projects/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!createResponse.ok) {
        const error = await createResponse.json();
        setMessage(`‚ùå Project creation failed: ${error.detail}`);
        setLoading(false);
        return;
      }

      const projectData = await createResponse.json();
      const projectId = projectData.project_id;
      setLastCreatedProjectId(projectId);

      let finalMessage = `‚úÖ Project created successfully! Number: ${projectData.project_no}`;

      // 2. If LPO file exists, upload it
      if (lpoFile) {
        const uploadResult = await uploadLPOFile(projectId);
        finalMessage += `\n${uploadResult.message}`;
      }

      setMessage(finalMessage);

      // 3. Reset form
      setFormData({
        quotation_id: '',
        project_name: '',
        location: '',
        lpo_no: '',
        lpo_date: ''
      });
      setLpoFile(null);
      setSelectedQuotation(null);

    } catch (error) {
      setMessage(`‚ùå Network error: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="module-content">
      <div className="module-header">
        <h2>Create New Project</h2>
      </div>

      {message && (
        <div className={`message ${message.includes('‚úÖ') ? 'success' : 'error'}`}>
          {message.split('\n').map((line, i) => (
            <div key={i}>{line}</div>
          ))}
        </div>
      )}

      <form onSubmit={handleSubmit} className="project-form">
        <div className="form-grid">
          <div className="form-group">
            <label htmlFor="quotation_id">Select Approved Quotation *</label>
            <select
              id="quotation_id"
              name="quotation_id"
              value={formData.quotation_id}
              onChange={handleChange}
              required
              className="form-input"
            >
              <option value="">Select an approved quotation</option>
              {approvedQuotations.map((quotation) => (
                <option key={quotation.quotation_id} value={quotation.quotation_id}>
                  {quotation.quotation_no} - {quotation.client_name} - {quotation.project_name}
                </option>
              ))}
            </select>
            <small className="field-hint">
              Only approved quotations can be converted to projects
            </small>
          </div>

          {selectedQuotation && (
            <>
              <div className="form-group">
                <label htmlFor="project_name">Project Name *</label>
                <input
                  type="text"
                  id="project_name"
                  name="project_name"
                  value={formData.project_name}
                  onChange={handleChange}
                  required
                  placeholder="Enter project name"
                  className="form-input"
                />
                <small className="field-hint">Auto-filled from quotation</small>
              </div>

              <div className="form-group">
                <label htmlFor="location">Location *</label>
                <input
                  type="text"
                  id="location"
                  name="location"
                  value={formData.location}
                  onChange={handleChange}
                  required
                  placeholder="Enter location"
                  className="form-input"
                />
                <small className="field-hint">Auto-filled from quotation</small>
              </div>

              <div className="form-group">
                <label htmlFor="lpo_no">LPO Number</label>
                <input
                  type="text"
                  id="lpo_no"
                  name="lpo_no"
                  value={formData.lpo_no}
                  onChange={handleChange}
                  placeholder="Enter LPO number"
                  className="form-input"
                />
              </div>

              <div className="form-group">
                <label htmlFor="lpo_date">LPO Date</label>
                <input
                  type="date"
                  id="lpo_date"
                  name="lpo_date"
                  value={formData.lpo_date}
                  onChange={handleChange}
                  className="form-input"
                />
              </div>

              <div className="form-group full-width">
                <label htmlFor="lpo_file">Upload LPO Document</label>
                <input
                  type="file"
                  id="lpo_file"
                  name="lpo_file"
                  onChange={handleFileChange}
                  accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                  className="form-input"
                />
                <small className="field-hint">
                  Supported formats: PDF, Word, Images
                  {lpoFile && ` - Selected: ${lpoFile.name}`}
                </small>
              </div>
            </>
          )}
        </div>

        <div className="form-actions">
          <button
            type="submit"
            disabled={loading || !formData.quotation_id}
            className="btn-primary"
          >
            {loading ? 'Creating Project...' : 'Create Project & Upload LPO'}
          </button>
        </div>
      </form>

      {selectedQuotation && (
        <div
          className="quotation-preview"
          style={{
            marginTop: '20px',
            padding: '15px',
            background: '#f8f9fa',
            borderRadius: '8px',
            border: '1px solid #e9ecef'
          }}
        >
          <h4>Selected Quotation Details</h4>
          <div className="info-grid">
            <div className="info-item">
              <label>Quotation No:</label>
              <span>{selectedQuotation.quotation_no}</span>
            </div>
            <div className="info-item">
              <label>Client:</label>
              <span>{selectedQuotation.client_name}</span>
            </div>
            <div className="info-item">
              <label>Division:</label>
              <span>{selectedQuotation.division}</span>
            </div>
            <div className="info-item">
              <label>Total Amount:</label>
              <span>${selectedQuotation.grand_total?.toFixed(2)}</span>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}



########################################################
VIEW PROJECTS
########################################################

// src/components/projects/ViewProjects.jsx - WITH VIEW MODE
import { useState, useEffect } from "react";

export default function ViewProjects() {
  const [projects, setProjects] = useState([]);
  const [loading, setLoading] = useState(true);
  const [message, setMessage] = useState('');
  const [editingProject, setEditingProject] = useState(null);
  const [viewingProject, setViewingProject] = useState(null);
  const [editForm, setEditForm] = useState({
    project_name: '',
    lpo_no: '',
    lpo_date: ''
  });
  const [selectedFiles, setSelectedFiles] = useState({});
  const [uploading, setUploading] = useState(false);

  useEffect(() => {
    fetchProjects();
  }, []);

  const fetchProjects = async () => {
    try {
      setLoading(true);
      const response = await fetch('http://127.0.0.1:8000/projects/projects');
      if (response.ok) {
        const data = await response.json();
        setProjects(data);
        setMessage('');
      } else {
        const error = await response.text();
        setMessage('‚ùå Failed to fetch projects');
      }
    } catch (error) {
      setMessage(`‚ùå Network error: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  const handleViewProject = async (project) => {
    try {
      // Fetch full project details for the view
      const response = await fetch(`http://127.0.0.1:8000/projects/${project.project_id}`);
      if (response.ok) {
        const projectDetails = await response.json();
        setViewingProject(projectDetails);
      } else {
        setMessage('‚ùå Failed to fetch project details');
      }
    } catch (error) {
      setMessage(`‚ùå Network error: ${error.message}`);
    }
  };

  const handleCloseView = () => {
    setViewingProject(null);
  };

  const handleEditProject = (project) => {
    setEditingProject(project);
    setEditForm({
      project_name: project.project_name || '',
      lpo_no: project.lpo_no || '',
      lpo_date: project.lpo_date || ''
    });
    setSelectedFiles(prev => ({ ...prev, [project.project_id]: null }));
  };

  const handleCancelEdit = () => {
    setEditingProject(null);
    setEditForm({
      project_name: '',
      lpo_no: '',
      lpo_date: ''
    });
  };

  const handleUpdateProject = async (e) => {
    e.preventDefault();
    if (!editingProject) return;

    try {
      const payload = {
        quotation_id: editingProject.quotation_id,
        project_name: editForm.project_name,
        location: editingProject.location,
        lpo_no: editForm.lpo_no || undefined,
        lpo_date: editForm.lpo_date || undefined
      };

      const response = await fetch(`http://127.0.0.1:8000/projects/${editingProject.project_id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });

      if (response.ok) {
        const data = await response.json();
        setMessage('‚úÖ Project updated successfully!');
        setEditingProject(null);
        fetchProjects();
      } else {
        const error = await response.json();
        setMessage(`‚ùå Error: ${error.detail}`);
      }
    } catch (error) {
      setMessage(`‚ùå Network error: ${error.message}`);
    }
  };

  const handleFileSelect = (projectId, file) => {
    if (file) {
      setSelectedFiles(prev => ({
        ...prev,
        [projectId]: file
      }));
    }
  };

  const handleFileUpload = async (projectId) => {
    const file = selectedFiles[projectId];
    if (!file) {
      setMessage('‚ùå Please select a file first');
      return;
    }

    setUploading(true);
    const uploadFormData = new FormData();
    uploadFormData.append('file', file);

    try {
      setMessage('üì§ Uploading file...');
      const response = await fetch(`http://127.0.0.1:8000/projects/${projectId}/upload-lpo`, {
        method: 'POST',
        body: uploadFormData,
      });

      if (response.ok) {
        const result = await response.json();
        setMessage(`‚úÖ LPO file uploaded successfully: ${result.file_name}`);
        
        setSelectedFiles(prev => ({
          ...prev,
          [projectId]: null
        }));
        
        fetchProjects();
      } else {
        const error = await response.json();
        setMessage(`‚ùå Failed to upload LPO: ${error.detail}`);
      }
    } catch (error) {
      setMessage(`‚ùå Network error during upload: ${error.message}`);
    } finally {
      setUploading(false);
    }
  };

  const downloadLPO = (projectId) => {
    window.open(`http://127.0.0.1:8000/projects/${projectId}/download-lpo`, '_blank');
  };

  // Project Details View Component
  const ProjectDetailsView = ({ project, onClose }) => {
    return (
      <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        backgroundColor: 'rgba(0,0,0,0.5)',
        display: 'flex',
        justifyContent: 'center',
        alignItems: 'center',
        zIndex: 1000
      }}>
        <div style={{
          background: 'white',
          padding: '24px',
          borderRadius: '8px',
          width: '90%',
          maxWidth: '500px',
          maxHeight: '90vh',
          overflow: 'auto',
          boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
        }}>
          <div style={{
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            marginBottom: '20px',
            borderBottom: '1px solid #e0e0e0',
            paddingBottom: '15px'
          }}>
            <h2 style={{ margin: 0, color: '#333' }}>Project Details</h2>
            <button 
              onClick={onClose}
              style={{
                background: 'none',
                border: 'none',
                fontSize: '24px',
                cursor: 'pointer',
                color: '#666'
              }}
            >
              √ó
            </button>
          </div>

          <div style={{
            display: 'grid',
            gap: '16px'
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <strong>Project Number:</strong>
              <span>{project.project_no}</span>
            </div>
            
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <strong>Project Name:</strong>
              <span>{project.project_name}</span>
            </div>
            
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <strong>Client:</strong>
              <span>{project.client_name || 'N/A'}</span>
            </div>
            
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <strong>Location:</strong>
              <span>{project.location}</span>
            </div>
            
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <strong>Quotation No:</strong>
              <span>{project.quotation_no || 'N/A'}</span>
            </div>
            
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <strong>LPO Number:</strong>
              <span>{project.lpo_no || '-'}</span>
            </div>
            
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <strong>LPO Date:</strong>
              <span>{project.lpo_date || '-'}</span>
            </div>
            
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <strong>Status:</strong>
              <span style={{
                padding: '4px 12px',
                borderRadius: '12px',
                fontSize: '12px',
                fontWeight: 'bold',
                backgroundColor: project.status === 'ACTIVE' ? '#d4edda' : '#f8d7da',
                color: project.status === 'ACTIVE' ? '#155724' : '#721c24'
              }}>
                {project.status}
              </span>
            </div>

            {/* LPO File Section */}
            <div style={{
              marginTop: '20px',
              padding: '16px',
              backgroundColor: '#f8f9fa',
              borderRadius: '6px',
              border: '1px solid #e9ecef'
            }}>
              <strong style={{ display: 'block', marginBottom: '8px' }}>LPO Document:</strong>
              {project.lpo_file ? (
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <span style={{ 
                    background: '#e9ecef',
                    padding: '6px 12px',
                    borderRadius: '4px',
                    fontSize: '14px',
                    flex: 1
                  }}>
                    {project.lpo_file}
                  </span>
                  <button 
                    onClick={() => downloadLPO(project.project_id)}
                    style={{
                      background: '#007bff',
                      color: 'white',
                      border: 'none',
                      padding: '8px 16px',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      fontSize: '14px',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px'
                    }}
                  >
                    üì• View LPO
                  </button>
                </div>
              ) : (
                <div style={{ color: '#6c757d', fontStyle: 'italic' }}>
                  No LPO document uploaded
                </div>
              )}
            </div>
          </div>

          <div style={{
            marginTop: '24px',
            display: 'flex',
            justifyContent: 'flex-end',
            gap: '12px',
            borderTop: '1px solid #e0e0e0',
            paddingTop: '20px'
          }}>
            <button 
              onClick={onClose}
              style={{
                background: '#6c757d',
                color: 'white',
                border: 'none',
                padding: '10px 20px',
                borderRadius: '6px',
                cursor: 'pointer',
                fontSize: '14px'
              }}
            >
              Close
            </button>
          </div>
        </div>
      </div>
    );
  };

  if (loading) {
    return (
      <div className="module-content">
        <div className="loading">Loading projects...</div>
      </div>
    );
  }

  // Show project details view if viewing
  if (viewingProject) {
    return <ProjectDetailsView project={viewingProject} onClose={handleCloseView} />;
  }

  return (
    <div className="module-content">
      <div className="module-header">
        <div>
          <h2>All Projects</h2>
          <div className="project-count">
            {projects.length} project{projects.length !== 1 ? 's' : ''} found
          </div>
        </div>
        <button onClick={() => window.location.href = '/projects/create'}>
          + Create New Project
        </button>
      </div>

      {message && (
        <div className={`message ${message.includes('‚úÖ') ? 'success' : 'error'}`}>
          {message}
        </div>
      )}

      <button onClick={fetchProjects}>üîÑ Refresh List</button>

      {projects.length === 0 ? (
        <div className="no-data">
          <h3>No Projects Found</h3>
          <button onClick={() => window.location.href = '/projects/create'}>
            + Create First Project
          </button>
        </div>
      ) : (
        <div className="projects-table-container">
          <table className="projects-table">
            <thead>
              <tr>
                <th>Project No</th>
                <th>Project Name</th>
                <th>Client</th>
                <th>Location</th>
                <th>Quotation No</th>
                <th>LPO No</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>

<tbody>
  {projects.map((project) => (
    <tr key={project.project_id}>
      <td>{project.project_no}</td>
      
      <td>
        {editingProject?.project_id === project.project_id ? (
          <input
            type="text"
            value={editForm.project_name}
            onChange={(e) => setEditForm({...editForm, project_name: e.target.value})}
            style={{ 
              padding: '6px', 
              border: '1px solid #ccc', 
              borderRadius: '4px',
              width: '100%',
              fontSize: '14px'
            }}
          />
        ) : (
          project.project_name
        )}
      </td>
      
      <td>{project.client_name || 'N/A'}</td>
      <td>{project.location}</td>
      <td>{project.quotation_no || 'N/A'}</td>
      
      <td>
        {editingProject?.project_id === project.project_id ? (
          <input
            type="text"
            value={editForm.lpo_no}
            onChange={(e) => setEditForm({...editForm, lpo_no: e.target.value})}
            placeholder="Enter LPO number"
            style={{ 
              padding: '6px', 
              border: '1px solid #ccc', 
              borderRadius: '4px',
              width: '100%',
              fontSize: '14px'
            }}
          />
        ) : (
          project.lpo_no || '-'
        )}
      </td>
      
      <td>
        <span style={{
          padding: '4px 8px',
          borderRadius: '12px',
          fontSize: '12px',
          fontWeight: 'bold',
          backgroundColor: project.status === 'ACTIVE' ? '#d4edda' : '#f8d7da',
          color: project.status === 'ACTIVE' ? '#155724' : '#721c24'
        }}>
          {project.status}
        </span>
      </td>
      
      <td>
        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', minWidth: '200px' }}>
          {editingProject?.project_id === project.project_id ? (
            <>
              {/* Edit Form Actions */}
              <div style={{ display: 'flex', gap: '4px' }}>
                <button 
                  onClick={handleUpdateProject}
                  style={{
                    background: '#28a745',
                    color: 'white',
                    border: 'none',
                    padding: '8px 12px',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontSize: '12px',
                    flex: 1
                  }}
                >
                  ‚úÖ Save
                </button>
                <button 
                  onClick={handleCancelEdit}
                  style={{
                    background: '#6c757d',
                    color: 'white',
                    border: 'none',
                    padding: '8px 12px',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontSize: '12px',
                    flex: 1
                  }}
                >
                  ‚ùå Cancel
                </button>
              </div>

              {/* File Upload Section */}
              <div style={{ 
                border: '1px solid #e0e0e0', 
                padding: '12px', 
                borderRadius: '6px',
                backgroundColor: '#f8f9fa'
              }}>
                <div style={{ marginBottom: '12px' }}>
                  <label style={{
                    display: 'block',
                    background: '#007bff',
                    color: 'white',
                    border: 'none',
                    padding: '8px 12px',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontSize: '12px',
                    textAlign: 'center',
                    marginBottom: '8px'
                  }}>
                    üìé Choose LPO File
                    <input
                      type="file"
                      onChange={(e) => handleFileSelect(project.project_id, e.target.files[0])}
                      style={{ display: 'none' }}
                      accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                    />
                  </label>
                  
                  {/* Show selected file name */}
                  {selectedFiles[project.project_id] && (
                    <div style={{
                      fontSize: '12px',
                      color: '#28a745',
                      fontWeight: 'bold',
                      textAlign: 'center',
                      padding: '4px',
                      backgroundColor: '#d4edda',
                      borderRadius: '4px'
                    }}>
                      ‚úÖ Selected: {selectedFiles[project.project_id].name}
                    </div>
                  )}
                </div>

                {/* Upload Button */}
                {selectedFiles[project.project_id] && (
                  <button 
                    onClick={() => handleFileUpload(project.project_id)}
                    disabled={uploading}
                    style={{
                      background: uploading ? '#6c757d' : '#28a745',
                      color: 'white',
                      border: 'none',
                      padding: '8px 12px',
                      borderRadius: '4px',
                      cursor: uploading ? 'not-allowed' : 'pointer',
                      fontSize: '12px',
                      width: '100%',
                      marginBottom: '8px'
                    }}
                  >
                    {uploading ? '‚¨ÜÔ∏è Uploading...' : '‚¨ÜÔ∏è Upload File'}
                  </button>
                )}

                {/* Download Button for existing files */}
                {project.lpo_file && (
                  <button 
                    onClick={() => downloadLPO(project.project_id)}
                    style={{
                      background: '#17a2b8',
                      color: 'white',
                      border: 'none',
                      padding: '8px 12px',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      fontSize: '12px',
                      width: '100%'
                    }}
                  >
                    üì• Download LPO
                  </button>
                )}
              </div>

              {/* LPO Date Input */}
              <div>
                <label style={{ fontSize: '12px', fontWeight: 'bold', display: 'block', marginBottom: '4px' }}>
                  LPO Date:
                </label>
                <input
                  type="date"
                  value={editForm.lpo_date}
                  onChange={(e) => setEditForm({...editForm, lpo_date: e.target.value})}
                  style={{ 
                    padding: '6px', 
                    border: '1px solid #ccc', 
                    borderRadius: '4px',
                    width: '100%',
                    fontSize: '12px'
                  }}
                />
              </div>
            </>
          ) : (
            /* View Mode - View & Edit Buttons */
            <div style={{ display: 'flex', gap: '8px' }}>
              <button 
                onClick={() => handleViewProject(project)}
                style={{
                  background: '#17a2b8',
                  color: 'white',
                  border: 'none',
                  padding: '8px 12px',
                  borderRadius: '4px',
                  cursor: 'pointer',
                  fontSize: '12px',
                  flex: 1,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '4px'
                }}
              >
                üëÅ View
              </button>

              <button 
                onClick={() => handleEditProject(project)}
                style={{
                  background: '#ffc107',
                  color: '#212529',
                  border: 'none',
                  padding: '8px 12px',
                  borderRadius: '4px',
                  cursor: 'pointer',
                  fontSize: '12px',
                  flex: 1,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '4px'
                }}
              >
                ‚úèÔ∏è Edit
              </button>
            </div>
          )}
        </div>
      </td>
    </tr>
  ))}
</tbody>
          </table>
        </div>
      )}
    </div>
  );
}

########################################################
PROJECT DETAILS
########################################################

// src/components/projects/ProjectDetails.jsx
export default function ProjectDetails({ project, onClose, onEdit }) {
  const downloadLPO = () => {
    if (project.lpo_file) {
      // This would need to be implemented based on your file serving setup
      window.open(`http://127.0.0.1:8000/projects/${project.project_id}/download-lpo`, '_blank');
    }
  };

  return (
    <div className="project-details-overlay">
      <div className="project-details-modal">
        <div className="modal-header">
          <h3>Project Details: {project.project_no}</h3>
          <button onClick={onClose} className="close-btn">√ó</button>
        </div>

        <div className="project-info">
          <div className="info-grid">
            <div className="info-item">
              <label>Project Number:</label>
              <span>{project.project_no}</span>
            </div>
            <div className="info-item">
              <label>Project Name:</label>
              <span>{project.project_name}</span>
            </div>
            <div className="info-item">
              <label>Client:</label>
              <span>{project.client_name || 'N/A'}</span>
            </div>
            <div className="info-item">
              <label>Location:</label>
              <span>{project.location}</span>
            </div>
            <div className="info-item">
              <label>Quotation No:</label>
              <span>{project.quotation_no || 'N/A'}</span>
            </div>
            <div className="info-item">
              <label>LPO Number:</label>
              <span>{project.lpo_no || '-'}</span>
            </div>
            <div className="info-item">
              <label>LPO Date:</label>
              <span>{project.lpo_date || '-'}</span>
            </div>
            <div className="info-item">
              <label>Status:</label>
              <span className={`status-badge status-${project.status?.toLowerCase()}`}>
                {project.status}
              </span>
            </div>
            <div className="info-item full-width">
              <label>LPO Document:</label>
              <div className="lpo-file-section">
                {project.lpo_file ? (
                  <div className="file-info">
                    <span className="file-name">{project.lpo_file}</span>
                    <button onClick={downloadLPO} className="btn-download">
                      üì• Download
                    </button>
                  </div>
                ) : (
                  <span className="no-file">No LPO document uploaded</span>
                )}
              </div>
            </div>
          </div>
        </div>

        <div className="modal-actions">
          <button onClick={onEdit} className="btn-primary">
            ‚úèÔ∏è Edit Project
          </button>
          <button onClick={onClose} className="btn-secondary">
            Close
          </button>
        </div>
      </div>
    </div>
  );
}


########################################################
VIEW PROJECTS
########################################################




########################################################
VIEW PROJECTS
########################################################



########################################################
VIEW PROJECTS
########################################################
